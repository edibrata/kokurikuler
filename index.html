<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Rapor Kokurikuler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Pustaka untuk menangani file Excel (XLSX) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Pustaka untuk menangani file PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .tab-button { transition: all 0.2s ease-in-out; }
        .tab-button:not(.tab-active):hover:not(:disabled) { background-color: #f0f9ff; color: #0284c7; }
        .tab-button:disabled { cursor: not-allowed; pointer-events: none; }
        .tab-active { border-color: #0284c7; background-color: #0284c7; color: white; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .tab-content { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .kegiatan-body {
            transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out, padding 0.5s ease-in-out;
            overflow: hidden; max-height: 0; opacity: 0; padding-top: 0; padding-bottom: 0;
        }
        .kegiatan-body.open {
            max-height: 5000px; /* Increased max-height */ opacity: 1; padding-top: 1rem; padding-bottom: 1rem;
        }
        .toggle-icon { transition: transform 0.3s ease-in-out; }
        .tooltip-container { position: relative; display: inline-flex; align-items: center; }
        .tooltip { 
            visibility: hidden; opacity: 0; transition: opacity 0.3s;
            position: absolute; top: 110%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1e293b; color: white; text-align: center;
            padding: 8px 12px; border-radius: 6px; z-index: 100;
            width: max-content;
            max-width: 300px;
            font-size: 0.8rem; font-weight: 500;
            white-space: normal;
        }
        .tooltip-left { left: 0; transform: translateX(0); }
        .tooltip-left::after { left: 20px; }
        .tooltip::after {
            content: ""; position: absolute; bottom: 100%;
            left: 50%;
            margin-left: -5px; border-width: 5px; border-style: solid;
            border-color: transparent transparent #1e293b transparent;
        }
        .tooltip-container:hover .tooltip, .tooltip-container:focus-within .tooltip { visibility: visible; opacity: 1; }
        .tooltip:empty { display: none; }
        .kriteria-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        .kriteria-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            line-height: 1.25;
            resize: vertical;
        }
        .kriteria-input::placeholder {
            color: #94a3b8;
        }
        /* Style for sticky assessment table headers */
        .asesmen-table-sticky thead th {
            position: sticky;
            background-color: #f8fafc; /* slate-50 color for consistency */
            text-align: center;
            vertical-align: middle;
        }
        .asesmen-table-sticky thead tr:nth-of-type(1) th { top: 0; z-index: 3; }
        .asesmen-table-sticky thead tr:nth-of-type(2) th { top: 45px; z-index: 2; } /* Adjusted for the first header row */
        .asesmen-table-sticky thead th[rowspan="2"] { z-index: 4; } /* Ensures 'Nama Murid' is always on top (changed from 3 to 2) */
        
        .asesmen-table-sticky .tooltip-container:hover, .asesmen-table-sticky .tooltip-container:focus-within {
            z-index: 20;
        }
        
        /* Style for action buttons in Murid table */
        .murid-table-btn {
            background: none; border: none; cursor: pointer;
            padding: 0.25rem 0.5rem; border-radius: 0.25rem;
            transition: background-color 0.2s;
        }
        .murid-table-btn:hover { background-color: #e2e8f0; }
        .murid-table-btn:disabled { color: #cbd5e1; cursor: not-allowed; }
        .murid-table-btn:disabled:hover { background-color: transparent; }
        
        /* Styles for Identitas Accordion */
        .identitas-section-header {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .identitas-section-header:hover {
            background-color: #f1f5f9;
        }
        .identitas-section-body {
            transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out, padding 0.5s ease-in-out, margin 0.5s ease-in-out;
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-top: 0;
        }
        .identitas-section-body.open {
            max-height: 1500px;
            opacity: 1;
            padding-top: 1.25rem;
            padding-bottom: 1.25rem;
            margin-top: -1px;
        }
        .identitas-toggle-icon {
            transition: transform 0.3s ease-in-out;
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            #tab-nav {
                grid-template-columns: repeat(3, 1fr);
            }
            #tab-nav .tab-wrapper:nth-child(4), #tab-nav .tab-wrapper:nth-child(5) {
                grid-column: span 1 / span 1;
            }
             #tab-nav .tab-wrapper:nth-child(4) {
                grid-column-start: 1;
            }
            #tab-nav .tab-wrapper:nth-child(5) {
                grid-column-start: 2;
                grid-column-end: 4;
            }
            .kriteria-grid {
                 grid-template-columns: repeat(1, 1fr);
            }
            .perancangan-toolbar, .asesmen-toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            .perancangan-toolbar > div, .asesmen-toolbar > div {
                justify-content: center;
                width: 100%;
            }
        }
         @media (max-width: 480px) {
            #tab-nav {
                grid-template-columns: repeat(2, 1fr);
            }
             #tab-nav .tab-wrapper:nth-child(n) {
                grid-column: auto;
            }
            .text-3xl {
                font-size: 1.5rem; /* 24px */
            }
         }
    </style>
</head>
<body class="text-slate-800 p-4 sm:p-6 md:p-8">

    <div>
        <main class="bg-white rounded-xl shadow-lg border border-slate-200">
            <header class="text-center relative bg-gradient-to-b from-white to-slate-50 pb-8 pt-6 border-b rounded-t-xl">
                <h1 class="text-3xl md:text-4xl font-bold text-sky-800 tracking-tight">Generator Kegiatan Kokurikuler</h1>
                <p class="mt-2 text-sm text-slate-500 max-w-2xl mx-auto">Aplikasi Generator Deskripsi Kegiatan Kokurikuler<br>Copyright © 2025 Edi Brata • Professional Edition • Versi 1.0 built 20250901</p>
                <div class="absolute top-4 right-4 flex gap-2">
                    <div class="tooltip-container">
                        <button id="backup-btn" aria-label="Backup Data" class="w-9 h-9 flex items-center justify-center bg-slate-100 hover:bg-slate-200 rounded-full text-slate-600 transition-colors">
                            <i class="fas fa-download"></i>
                        </button>
                        <span class="tooltip" role="tooltip">Backup</span>
                    </div>
                    <div class="tooltip-container">
                        <button id="restore-btn" aria-label="Restore Data" class="w-9 h-9 flex items-center justify-center bg-slate-100 hover:bg-slate-200 rounded-full text-slate-600 transition-colors">
                            <i class="fas fa-upload"></i>
                        </button>
                        <span class="tooltip" role="tooltip">Restore</span>
                    </div>
                    <input type="file" id="restore-file-input" class="hidden" accept=".json">
                    <div class="tooltip-container">
                        <button id="panduan-btn" aria-label="Buka Petunjuk" class="w-9 h-9 flex items-center justify-center bg-slate-100 hover:bg-slate-200 rounded-full text-slate-600 transition-colors">
                            <i class="fas fa-question"></i>
                        </button>
                        <span class="tooltip" role="tooltip">Petunjuk</span>
                    </div>
                     <div class="tooltip-container">
                        <button id="profil-btn" aria-label="Buka Profil Pengembang" class="w-9 h-9 flex items-center justify-center bg-slate-100 hover:bg-slate-200 rounded-full text-slate-600 transition-colors">
                            <i class="fas fa-user"></i>
                        </button>
                        <span class="tooltip" role="tooltip">Pengembang</span>
                    </div>
                </div>
            </header>

            <!-- Tab Navigation -->
            <div id="tab-nav" role="tablist" aria-label="Navigasi Utama" class="grid grid-cols-2 md:grid-cols-5 border-b border-slate-200 p-2 bg-slate-50">
                <div class="tab-wrapper flex-1"><button id="tab-identitas" role="tab" aria-controls="identitas-content" aria-selected="true" data-tab="identitas" class="tab-button w-full flex-1 py-3 px-4 text-center text-sm md:text-base font-semibold rounded-lg"><i class="fas fa-id-card mr-2"></i>1. Identitas</button></div>
                <div class="tooltip-container tab-wrapper flex-1">
                    <button id="tab-murid" role="tab" aria-controls="murid-content" aria-selected="false" tabindex="-1" data-tab="murid" class="tab-button w-full flex-1 py-3 px-4 text-center text-sm md:text-base font-semibold rounded-lg text-slate-500"><i class="fas fa-users mr-2"></i>2. Data Murid</button>
                    <span class="tooltip" role="tooltip"></span>
                </div>
                <div class="tooltip-container tab-wrapper flex-1">
                    <button id="tab-perancangan" role="tab" aria-controls="perancangan-content" aria-selected="false" tabindex="-1" data-tab="perancangan" class="tab-button w-full flex-1 py-3 px-4 text-center text-sm md:text-base font-semibold rounded-lg text-slate-500"><i class="fas fa-file-signature mr-2"></i>3. Perencanaan</button>
                    <span class="tooltip" role="tooltip"></span>
                </div>
                <div class="tooltip-container tab-wrapper flex-1">
                    <button id="tab-asesmen" role="tab" aria-controls="asesmen-content" aria-selected="false" tabindex="-1" data-tab="asesmen" class="tab-button w-full flex-1 py-3 px-4 text-center text-sm md:text-base font-semibold rounded-lg text-slate-500"><i class="fas fa-clipboard-check mr-2"></i>4. Asesmen</button>
                    <span class="tooltip" role="tooltip"></span>
                </div>
                <div class="tooltip-container tab-wrapper flex-1">
                    <button id="tab-hasil" role="tab" aria-controls="hasil-content" aria-selected="false" tabindex="-1" data-tab="hasil" class="tab-button w-full flex-1 py-3 px-4 text-center text-sm md:text-base font-semibold rounded-lg text-slate-500"><i class="fas fa-award mr-2"></i>5. Hasil Sintesis</button>
                    <span class="tooltip" role="tooltip"></span>
                </div>
            </div>

            <div class="p-6 md:p-8">
                <!-- Tab content for 1, 2, 3, 4, 5 will be generated by JS -->
                <div id="identitas-content" role="tabpanel" aria-labelledby="tab-identitas" class="tab-content hidden"></div>
                <div id="murid-content" role="tabpanel" aria-labelledby="tab-murid" class="tab-content hidden"></div>
                <div id="perancangan-content" role="tabpanel" aria-labelledby="tab-perancangan" class="tab-content hidden">
                     <section id="perancangan">
                        <!-- Main Action Toolbar -->
                        <div class="perancangan-toolbar flex flex-wrap gap-2 justify-between items-center mb-6 border-b border-slate-200 pb-6">
                            <div class="flex flex-wrap gap-2">
                                <div class="tooltip-container">
                                   <button id="save-template-btn" class="inline-flex items-center justify-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-blue-700"><i class="fas fa-file-excel mr-2"></i>Template</button>
                                   <span class="tooltip tooltip-left" role="tooltip">Unduh templat Excel kosong untuk merencanakan kegiatan</span>
                               </div>
                               <div class="tooltip-container">
                                   <button id="export-data-btn" class="inline-flex items-center justify-center px-4 py-2 bg-teal-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-teal-700"><i class="fas fa-file-export mr-2"></i>Ekspor</button>
                                   <span class="tooltip tooltip-left" role="tooltip">Ekspor semua data perencanaan kegiatan ke file Excel</span>
                               </div>
                               <div class="tooltip-container">
                                   <button id="import-data-btn" class="inline-flex items-center justify-center px-4 py-2 bg-slate-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-slate-700"><i class="fas fa-file-import mr-2"></i>Impor</button>
                                   <span class="tooltip tooltip-left" role="tooltip">Impor data perencanaan dari file templat Excel</span>
                               </div>
                               <input type="file" id="import-file-input" class="hidden" accept=".xlsx, .xls">
                               <div class="tooltip-container">
                                    <button id="clear-state-btn" class="inline-flex items-center justify-center px-4 py-2 bg-amber-500 text-white text-sm font-medium rounded-md shadow-sm hover:bg-amber-600"><i class="fas fa-undo mr-2"></i>Reset</button>
                                    <span class="tooltip tooltip-left" role="tooltip">Hapus semua data Perencanaan dan Asesmen. Data Identitas dan Daftar Murid tidak akan terhapus.</span>
                               </div>
                                <div class="tooltip-container">
                                    <button id="undo-perancangan-btn" type="button" class="murid-table-btn text-slate-600" aria-label="Undo"><i class="fas fa-undo-alt"></i></button>
                                    <span class="tooltip" role="tooltip">Batalkan (Undo)</span>
                                </div>
                                <div class="tooltip-container">
                                    <button id="redo-perancangan-btn" type="button" class="murid-table-btn text-slate-600" aria-label="Redo"><i class="fas fa-redo-alt"></i></button>
                                    <span class="tooltip" role="tooltip">Ulangi (Redo)</span>
                                </div>
                            </div>
                            <div class="tooltip-container">
                                <button id="tambah-kegiatan" class="inline-flex items-center px-4 py-2 bg-sky-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-sky-700"><i class="fas fa-plus mr-2"></i>Tambah</button>
                                <span class="tooltip" role="tooltip">Tambah kartu perencanaan kegiatan baru</span>
                            </div>
                        </div>
                        
                        <div id="kegiatan-container" class="space-y-3"></div>
                    </section>
                </div>
                <div id="asesmen-content" role="tabpanel" aria-labelledby="tab-asesmen" class="tab-content hidden"></div>
                <div id="hasil-content" role="tabpanel" aria-labelledby="tab-hasil" class="tab-content hidden"></div>
            </div>
        </main>
    </div>

    <!-- Help Modal -->
    <div id="panduan-modal" role="dialog" aria-modal="true" aria-labelledby="panduan-title" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center p-5 border-b sticky top-0 bg-white">
                <h3 id="panduan-title" class="text-xl font-bold text-slate-800"><i class="fas fa-book-open mr-2 text-sky-600"></i>Petunjuk</h3>
                <button id="close-panduan-btn" aria-label="Tutup Petunjuk" class="text-slate-400 hover:text-slate-800 text-3xl font-bold">&times;</button>
            </div>
            <div class="p-6 text-slate-700 space-y-4">
                <div class="p-4 bg-blue-50 border-l-4 border-blue-400">
                    <p><strong>Penting:</strong> Pekerjaan Anda disimpan secara otomatis di browser. Jika Anda me-refresh halaman, data Anda tidak akan hilang.</p>
                </div>
                <div>
                    <h4 class="font-bold text-slate-800">Alur Kerja Aplikasi</h4>
                    <ul class="space-y-3 mt-2">
                        <li class="flex">
                            <i class="fas fa-id-card fa-fw mt-1 mr-3 text-slate-500"></i>
                            <div>
                                <strong>Tab 1: Identitas</strong><br>
                                Lengkapi semua data sekolah, kelas, kepala sekolah, dan guru. Semua isian wajib diisi untuk mengaktifkan tombol <strong>Simpan</strong> dan diperlukan untuk mencetak laporan.
                            </div>
                        </li>
                        <li class="flex">
                            <i class="fas fa-users fa-fw mt-1 mr-3 text-slate-500"></i>
                            <div>
                                <strong>Tab 2: Data Murid</strong><br>
                                Masukkan semua nama murid di kelas Anda. Anda bisa menambahkannya satu per satu dengan tombol <strong>+ Tambah Murid</strong>, atau mengimpor daftar nama dari file Excel.
                            </div>
                        </li>
                         <li class="flex">
                            <i class="fas fa-file-signature fa-fw mt-1 mr-3 text-slate-500"></i>
                            <div>
                                <strong>Tab 3: Perencanaan</strong><br>
                                Buat rencana kegiatan kokurikuler. Klik <strong>+ Tambah</strong> untuk membuat kartu kegiatan. Isi nama kegiatan, lalu tambahkan dimensi fokus dan pilih Subdimensi. Uraian Capaian (Berkembang, Cakap, Mahir) akan otomatis muncul.
                            </div>
                        </li>
                         <li class="flex">
                            <i class="fas fa-clipboard-check fa-fw mt-1 mr-3 text-slate-500"></i>
                            <div>
                                <strong>Tab 4: Asesmen</strong><br>
                                Pilih kegiatan dari daftar. Tabel akan muncul dengan daftar murid dan Subdimensi yang sudah Anda rencanakan. Isi nilai capaian (**M, C, B**) untuk setiap murid. Arahkan kursor ke judul Subdimensi untuk melihat uraian capaiannya.
                            </div>
                        </li>
                         <li class="flex">
                            <i class="fas fa-award fa-fw mt-1 mr-3 text-slate-500"></i>
                            <div>
                                <strong>Tab 5: Hasil Sintesis</strong><br>
                                Setelah asesmen diisi, klik tombol <strong>Sintesis & Lihat Hasil</strong> di tab Asesmen. Di tab ini, Anda akan melihat narasi rapor yang dibuat otomatis. Gunakan tombol aksi untuk mengganti variasi kalimat, mengedit manual, menyalin, atau mengekspor laporan akhir.
                            </div>
                        </li>
                    </ul>
                </div>
                <div class="pt-4 border-t">
                     <h4 class="font-bold text-slate-800">Manajemen Data (Tombol di Tab Perencanaan)</h4>
                     <ul class="space-y-2 mt-2">
                        <li class="flex items-start">
                            <i class="fas fa-file-excel fa-fw mr-3 text-blue-500"></i>
                            <span><strong>Template:</strong> Unduh file Excel kosong untuk merencanakan kegiatan atau mengisi nilai secara offline.</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-file-export fa-fw mr-3 text-teal-500"></i>
                            <span><strong>Ekspor:</strong> Simpan semua data perencanaan yang sudah Anda buat sebagai cadangan (backup).</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-file-import fa-fw mr-3 text-slate-500"></i>
                            <span><strong>Impor:</strong> Muat kembali data perencanaan atau data asesmen dari file template Excel yang sudah diisi.</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-undo fa-fw mr-3 text-amber-500"></i>
                            <span><strong>Reset:</strong> Menghapus SEMUA data (perencanaan, murid, asesmen) dari aplikasi. Gunakan dengan hati-hati.</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Profil Modal -->
    <div id="profil-modal" role="dialog" aria-modal="true" aria-labelledby="profil-title" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl">
            <div class="flex justify-between items-center p-5 border-b">
                <h3 id="profil-title" class="text-xl font-semibold text-gray-800 flex items-center gap-3">
                    <i class="fas fa-user-circle text-indigo-500"></i>
                    Pengembang Aplikasi
                </h3>
                <button id="close-profil-btn" aria-label="Tutup Profil" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="flex flex-col md:flex-row items-center md:items-start gap-6">
                    <div class="flex-shrink-0">
                        <img class="w-32 h-32 rounded-full object-cover shadow-md transition-transform duration-300 ease-in-out hover:scale-105"
                             src="https://drive.google.com/thumbnail?id=186OgVsvq7V-FrVAQIsKNcFjRwnwbDlzl"
                             alt="Foto Profil Edi Brata">
                    </div>
                    <div class="flex-1 text-center md:text-left">
                        <h2 class="text-2xl font-bold text-gray-900">Edi Brata</h2>
                        <p class="text-gray-500">Carita, Pandeglang Banten</p>
                        <p class="text-sm text-gray-500 mt-1">Klik untuk lihat portofolio atau berkomunikasi:</p>
                        <div class="flex justify-center md:justify-start space-x-4 mt-3 text-gray-600 text-xl">
                            <a href="https://www.tiktok.com/@edibrataeb" target="_blank" aria-label="TikTok Edi Brata" class="hover:text-indigo-500 transition-colors"><i class="fab fa-tiktok"></i></a>
                            <a href="https://www.instagram.com/edibrata/" target="_blank" aria-label="Instagram Edi Brata" class="hover:text-indigo-500 transition-colors"><i class="fab fa-instagram"></i></a>
                            <a href="https://web.facebook.com/uebrata" target="_blank" aria-label="Facebook Edi Brata" class="hover:text-indigo-500 transition-colors"><i class="fab fa-facebook-f"></i></a>
                            <a href="https://www.youtube.com/@EduOnlineEB" target="_blank" aria-label="YouTube Edi Brata" class="hover:text-indigo-500 transition-colors"><i class="fab fa-youtube"></i></a>
                            <a href="mailto:edibratabanten@gmail.com" aria-label="Email Edi Brata" class="hover:text-indigo-500 transition-colors"><i class="fas fa-envelope"></i></a>
                            <a href="https://wa.me/?text=Yth.%20Pa%20Edi%20Brata%2C%20%0A%0ASaya%20....%20dari%20SD%20...%20Kecamatan%20...%20Kabupaten%2FKota%20...%20%0A%0ASaya%20minat%20menggunakan%20aplikasi%20Rapor%20yang%20Bapak%20kembangkan." target="_blank" aria-label="WhatsApp Edi Brata" class="hover:text-indigo-500 transition-colors"><i class="fab fa-whatsapp"></i></a>
                        </div>
                    </div>
                </div>            
                    <div class="p-4 bg-gray-50 rounded-lg border md:col-span-2">
                        <h4 class="font-semibold text-gray-800 mb-2 flex items-center gap-2">
                            <i class="fas fa-laptop-code text-indigo-500"></i>Jejak Aktifitas
                        </h4>
                        <ul class="list-disc list-outside space-y-1 pl-5 text-gray-600">
                            <li>Guru Sejak 2003</li>
                            <li>10 Tahun Dosen</li>
                            <li>Instruktur Kurikulum</li>
                            <li>Pengembang Aplikasi Pembelajaran dan Penilaian</li>
                            <li>Google Certified Educator & Ko-Kapten Belajar.id</li>
                            <li>Tim Pengembang Konten MPI Direktorat SD Kemdikdasmen</li>                
                            <li>Tim Pengembang Beberapa Panduan Direktorat SD Kemdikdasmen</li>
                            <li>Tim Pengembang Modul Ajar Direktorat SD Kemdikdasmen</li>
                            <li>Fasilitator Direktorat SD Kemdikdasmen</li>
                            <li>Narasumber Berbagi Praktik Baik Kemdikdasmen</li>                            
                            <li>Validator Aksi Nyata PMM</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Confirmation Modal -->
    <div id="konfirmasi-modal" role="alertdialog" aria-modal="true" aria-labelledby="konfirmasi-title" aria-describedby="konfirmasi-message" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-5">
                <h3 id="konfirmasi-title" class="text-lg font-bold text-slate-800"><i class="fas fa-exclamation-triangle mr-2 text-amber-500"></i>Konfirmasi Tindakan</h3>
                <p id="konfirmasi-message" class="mt-2 text-slate-600">Apakah Anda yakin?</p>
            </div>
            <div class="flex justify-end items-center p-4 bg-slate-50 rounded-b-lg gap-3">
                <button id="konfirmasi-cancel-btn" class="px-4 py-2 border border-slate-300 text-sm font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50">Batal</button>
                <button id="konfirmasi-confirm-btn" class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-red-700">Ya, Lanjutkan</button>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notifikasi-modal" role="alertdialog" aria-modal="true" aria-labelledby="notifikasi-message" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm">
            <div class="p-6 text-center">
                <p id="notifikasi-message" class="text-slate-700 whitespace-pre-line text-center"></p>
                <button id="notifikasi-ok-btn" class="mt-4 px-6 py-2 bg-sky-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-sky-700">OK</button>
            </div>
        </div>
    </div>
    
    <!-- Report Export Modal -->
    <div id="ekspor-laporan-modal" role="dialog" aria-modal="true" aria-labelledby="ekspor-laporan-title" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
             <div class="flex justify-between items-center p-5 border-b">
                <h3 id="ekspor-laporan-title" class="text-lg font-bold text-slate-800"><i class="fas fa-file-export mr-2 text-teal-600"></i>Pilih Format Ekspor</h3>
                <button id="close-ekspor-laporan-btn" aria-label="Tutup Pilihan Ekspor" class="text-slate-400 hover:text-slate-800 text-3xl font-bold">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <button id="export-to-excel-btn" class="w-full text-left inline-flex items-start p-4 border rounded-lg hover:bg-slate-50">
                    <i class="fas fa-file-excel text-xl text-green-600 mt-1"></i>
                    <div class="ml-4">
                        <p class="font-semibold text-slate-800">Ekspor ke Excel</p>
                        <p class="text-sm text-slate-500">Unduh laporan dalam format file .xlsx.</p>
                    </div>
                </button>
                <button id="export-to-pdf-btn" class="w-full text-left inline-flex items-start p-4 border rounded-lg hover:bg-slate-50">
                    <i class="fas fa-file-pdf text-xl text-red-600 mt-1"></i>
                     <div class="ml-4">
                        <p class="font-semibold text-slate-800">Ekspor ke PDF</p>
                        <p class="text-sm text-slate-500">Unduh laporan dalam format file .pdf yang siap cetak.</p>
                    </div>
                </button>
            </div>
        </div>
    </div>


    <!-- HTML Templates -->
    <template id="kegiatan-template">
        <div class="kegiatan-card bg-slate-50 rounded-lg shadow-sm border border-slate-200">
            <div class="kegiatan-header flex justify-between items-center p-4 cursor-pointer hover:bg-slate-100">
                <input type="text" class="nama-kegiatan w-full text-lg font-semibold bg-transparent focus:outline-none focus:ring-0 border-none p-0" placeholder="Nama Kegiatan Baru...">
                <div class="flex items-center">
                    <div class="tooltip-container">
                        <button class="hapus-kegiatan text-slate-400 hover:text-red-500 ml-4 p-2 flex-shrink-0" aria-label="Hapus Kegiatan"><i class="fas fa-trash-alt"></i></button>
                        <span class="tooltip" role="tooltip">Hapus kegiatan ini</span>
                    </div>
                    <div class="tooltip-container">
                        <i class="toggle-icon fas fa-chevron-down text-slate-500 ml-4"></i>
                        <span class="tooltip" role="tooltip">Buka/Tutup detail kegiatan</span>
                    </div>
                </div>
            </div>
            <div class="kegiatan-body p-4 border-t border-slate-200">
                <div class="dimensi-container space-y-4"></div>
                <div class="tooltip-container">
                    <button class="tambah-dimensi mt-4 text-sm text-sky-600 hover:text-sky-800 font-bold"><i class="fas fa-layer-group mr-2"></i>+ Tambah Dimensi Fokus</button>
                    <span class="tooltip tooltip-left" role="tooltip">Tambah dimensi baru untuk kegiatan ini</span>
                </div>
            </div>
        </div>
    </template>

    <!-- MODIFIED dimensi-template -->
    <template id="dimensi-template">
         <div class="dimensi-block p-4 border border-slate-200 rounded-md bg-white origin-top">
            <div class="flex justify-between items-center mb-3">
                <select class="dimensi-select w-full p-2 border border-slate-300 rounded-md font-semibold text-gray-700"></select>
                <div class="tooltip-container">
                    <button class="hapus-dimensi text-slate-400 hover:text-red-500 ml-3" aria-label="Hapus Dimensi"><i class="fas fa-times"></i></button>
                    <span class="tooltip" role="tooltip">Hapus dimensi ini</span>
                </div>
            </div>
            <div class="subdimensi-container space-y-3 p-2 bg-slate-50 rounded-md">
                <p class="text-xs text-slate-500 font-semibold mb-2">Pilih satu atau lebih Subdimensi fokus:</p>
            </div>
        </div>
    </template>
    
    <!-- Template for a single Subdimensi Checkbox -->
    <template id="subdimensi-item-template">
        <div class="subdimensi-item p-3 border border-slate-200 rounded-md">
            <label class="flex items-start text-sm font-semibold cursor-pointer">
                <input type="checkbox" class="subdimensi-checkbox h-4 w-4 mt-1 text-sky-600 border-gray-300 rounded focus:ring-sky-500">
                <span class="subdimensi-name ml-3 text-gray-800 flex-1"></span>
            </label>
            <div class="subdimensi-capaian mt-3 space-y-1 text-xs pl-2 border-l-2 border-sky-200 hidden">
                <div class="font-bold text-gray-800 mb-1">Uraian Capaian:</div>
                <div class="berk-desc text-amber-600 border-l-2 border-amber-300 pl-2"><strong>Berkembang:</strong> </div>
                <div class="cakap-desc text-green-600 border-l-2 border-green-300 pl-2"><strong>Cakap:</strong> </div>
                <div class="mahir-desc text-sky-600 border-l-2 border-sky-300 pl-2"><strong>Mahir:</strong> </div>
            </div>
        </div>
    </template>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA & STATE ---
        let identitasData = {};
        let kegiatanData = {};
        let muridData = {};
        let daftarMurid = []; 
        let muridHistory = [[]];
        let muridHistoryIndex = 0;
        let identitasHistory = [{}];
        let identitasHistoryIndex = 0;
        let perancanganHistory = [{}];
        let perancanganHistoryIndex = 0;
        let activeTab = 'identitas';
        let currentAsesmenViewId = null;
        let isIdentitasComplete = false;
        
        // Data Dimensi dan Subdimensi (Berdasarkan Alur Perkembangan Kompetensi Dimensi Profil Lulusan SD.pdf)
        const subdimensiDetail = {
            "Keimanan & Ketakwaan": [
                { name: "Hubungan dengan Tuhan Yang Maha Esa", berk: "Mengenal ajaran Tuhan Yang Maha Esa melalui cerita, doa, dan praktek ibadah sesuai agamanya serta mulai memahami nilai kebaikan dalam kehidupan nyata.", cakap: "Membiasakan diri melaksanakan ajaran Tuhan Yang Maha Esa dalam kehidupan nyata secara konsisten dengan bimbingan orang tua dan guru serta mampu mensyukurinya.", mahir: "Melaksanakan ibadah secara mandiri sesuai ajaran Tuhan Yang Maha Esa secara konsisten dalam kehidupan nyata serta menjadi contoh dalam beribadah dan sikap religius di sekolah dan keluarga." },
                { name: "Hubungan dengan sesama Manusia", berk: "Mengenal dan mencoba bersikap jujur, peduli, dan tanggung jawab dengan bimbingan.", cakap: "Membiasakan bersikap jujur, adil, peduli, dan bertanggung jawab dalam interaksi dalam kehidupan nyata.", mahir: "Mampu mengajak teman sebaya untuk peduli terhadap lingkungan serta menunjukkan inisiatif dalam menjaga kebersihan lingkungan dan kelestarian alam sekitar." },
                { name: "Hubungan dengan Lingkungan Alam", berk: "Menunjukkan pemahaman kebersihan lingkungan dan kelestarian alam dengan bimbingan.", cakap: "Membiasakan menjaga kebersihan lingkungan dan kelestarian alam secara konsisten dan mandiri.", mahir: "Menjadi contoh bagi teman dalam kepedulian lingkungan serta mampu menunjukkan inisiatif dalam menjaga kebersihan lingkungan dan kelestarian alam." }
            ],
            "Kewargaan": [
                { name: "Kewargaan Lokal", berk: "Menunjukkan kesadaran atas aturan, norma, dan nilai sosial budaya yang berlaku di keluarga, satuan pendidikan, dan masyarakat.", cakap: "Berperilaku sesuai aturan, norma, dan nilai sosial budaya yang berlaku di keluarga, satuan pendidikan, dan masyarakat dengan bimbingan.", mahir: "Berperilaku sesuai aturan, norma, dan nilai sosial budaya yang berlaku di keluarga, satuan pendidikan, dan masyarakat secara mandiri." },
                { name: "Kewargaan Nasional", berk: "Menunjukkan kesadaran atas aturan, norma, dan nilai sosial budaya yang berlaku di lingkup nasional.", cakap: "Berperilaku sesuai aturan, norma, dan nilai sosial budaya yang berlaku di lingkup nasional dengan bimbingan.", mahir: "Berperilaku sesuai aturan, norma, dan nilai sosial budaya yang berlaku di lingkup nasional secara mandiri." },
                { name: "Kewargaan Global", berk: "Mengenali keberadaan negara lain di dunia dan simbol-simbolnya.", cakap: "Mengenal aturan, norma, dan nilai sosial budaya yang berlaku di lingkup global untuk menguatkan wawasan kebangsaan.", mahir: "Berperilaku sesuai aturan, norma, dan nilai sosial budaya yang berlaku di lingkup global dan menghargai keberagamannya dengan tetap menjaga identitas diri dan budaya nasional." }
            ],
            "Penalaran Kritis": [
                { name: "Penyampaian Argumentasi", berk: "Menyampaikan argumen sederhana namun belum tepat.", cakap: "Menyampaikan argumen sederhana secara runtut disertai alasan.", mahir: "Menyampaikan argumen sederhana secara runtut disertai alasan secara mandiri." },
                { name: "Pengambilan Keputusan", berk: "Mengambil keputusan namun belum logis dan belum berdasarkan informasi yang relevan.", cakap: "Mengambil keputusan secara logis berdasarkan informasi yang relevan.", mahir: "Mengambil keputusan secara logis berdasarkan informasi yang relevan secara mandiri." },
                { name: "Penyelesaian Masalah", berk: "Menyelesaikan masalah sederhana dan menghasilkan solusi namun kurang tepat.", cakap: "Menyelesaikan masalah sederhana dan menghasilkan solusi yang tepat sesuai dengan konteks.", mahir: "Menyelesaikan masalah sederhana dan menghasilkan solusi yang tepat sesuai dengan konteks secara mandiri." }
            ],
            "Kreativitas": [
                { name: "Gagasan baru", berk: "Menyampaikan gagasan secara sederhana meskipun belum runtut.", cakap: "Menyampaikan gagasan sederhana dengan jelas dan runtut.", mahir: "Menyampaikan beberapa gagasan sederhana dengan logis, jelas dan relevan." },
                { name: "Fleksibilitas Berpikir", berk: "Menemukan solusi masalah sederhana yang ditemui di lingkungan kelas dengan bantuan orang dewasa.", cakap: "Menemukan solusi alternatif dengan mengadaptasi berbagai gagasan.", mahir: "Menemukan beberapa solusi alternatif dan memberikan umpan balik pada alternatif solusinya." },
                { name: "Karya", berk: "Membuat tindakan dan/atau karya sederhana yang kreatif dengan berbagai ide yang sesuai minat dan kesukaannya.", cakap: "Membuat tindakan dan/atau karya sederhana yang kreatif sesuai minat dan kesukaannya.", mahir: "Membuat tindakan dan/atau karya sederhana yang kreatif dengan berbagai ide yang sesuai minat dan kesukaannya serta mengkritisi tindakan dan/atau karya yang dihasilkan." }
            ],
            "Kolaborasi": [
                { name: "Peduli", berk: "Mulai menunjukkan kepedulian pada teman sebaya dan anggota keluarga dengan bimbingan guru dan orang tua di lingkungan satuan pendidikan dan keluarga.", cakap: "Menunjukkan kepedulian secara konsisten pada teman sebaya dan anggota keluarga dengan bimbingan guru dan orang tua di lingkungan satuan pendidikan dan keluarga.", mahir: "Menunjukkan inisiatif kepedulian secara konsisten pada teman sebaya dan anggota keluarga di lingkungan satuan pendidikan dan keluarga." },
                { name: "Berbagi", berk: "Mulai berbagi hal yang dianggap penting dan berharga kepada teman sebaya dan anggota keluarga dengan bimbingan guru dan orang tua.", cakap: "Berbagi hal yang dianggap penting dan berharga kepada teman atau anggota keluarga dengan bimbingan guru dan orang tua.", mahir: "Menunjukkan inisiatif untuk berbagi hal yang dianggap penting dan berharga kepada teman atau anggota keluarga." },
                { name: "Kerja sama", berk: "Mulai bekerjasama dengan teman sebaya dan anggota keluarga dengan bimbingan guru dan orang tua di lingkungan satuan pendidikan dan keluarga.", cakap: "Bekerjasama dengan teman sebaya dan anggota keluarga dengan bimbingan guru dan orang tua di lingkungan satuan pendidikan dan keluarga.", mahir: "Menunjukkan inisiatif untuk bekerjasama dengan teman sebaya dan anggota keluarga dengan bimbingan guru dan orang tua di lingkungan satuan pendidikan dan keluarga." }
            ],
            "Kemandirian": [
                { name: "Bertanggung Jawab", berk: "Melakukan upaya mencapai tujuan pembelajaran sesuai arahan.", cakap: "Berlatih menetapkan tujuan pembelajaran untuk dirinya.", mahir: "Berlatih mencapai tujuan pembelajaran yang telah ditentukan sendiri secara tepat waktu." },
                { name: "Kepemimpinan", berk: "Menjalankan peran yang diberikan dalam konteks pembelajaran sesuai arahan.", cakap: "Menjalankan peran yang diberikan dalam konteks pembelajaran dengan arahan minimal.", mahir: "Berinisiatif untuk menjalankan peran dalam konteks pembelajaran secara otonom." },
                { name: "Pengembangan Diri", berk: "Mengenal minat dan bakat sebagai potensi diri dengan bimbingan penuh.", cakap: "Mengenal minat dan bakat sebagai potensi diri dan mengeksplorasi berbagai kegiatan pengembangan diri dengan bimbingan.", mahir: "Mengenal minat dan bakat sebagai potensi diri dan mengeksplorasi berbagai kegiatan pengembangan diri dengan bimbingan minimal." }
            ],
            "Kesehatan": [
                { name: "Hidup bersih dan sehat", berk: "Berperilaku hidup bersih dan sehat dengan memperhatikan dan menjaga kebersihan diri namun masih perlu bimbingan.", cakap: "Berperilaku hidup bersih dan sehat dengan memperhatikan dan menjaga kebersihan diri dengan bimbingan minimal.", mahir: "Mengajak orang lain untuk bersama-sama berperilaku hidup bersih dan sehat dengan memperhatikan dan menjaga kebersihan diri secara otonom dan teratur." },
                { name: "Kebugaran, kesehatan fisik, dan kesehatan mental", berk: "Berperilaku sehat fisik dan mental, menjaga kebugaran dengan berolahraga secara teratur, menerapkan pola makan sehat dan bergizi seimbang, serta mengendalikan emosi dengan bimbingan penuh.", cakap: "Berperilaku sehat fisik dan mental, menjaga kebugaran dengan berolahraga secara teratur, menerapkan pola makan sehat dan bergizi seimbang, serta mengendalikan emosi dengan bimbingan.", mahir: "Mengajak teman sebaya agar berperilaku sehat secara fisik dan mental, menjaga kebugaran dengan berolahraga secara teratur, menerapkan pola makan sehat dan bergizi seimbang, serta mengendalikan emosi dengan bimbingan minimal." },
                { name: "Kesehatan Lingkungan", berk: "Berperan aktif meningkatkan kesehatan lingkungan rumah dan sekolah dengan bimbingan penuh.", cakap: "Berperan aktif meningkatkan kesehatan lingkungan rumah dan sekolah.", mahir: "Mengajak teman sebaya untuk meningkatkan kesehatan lingkungan rumah dan sekolah." }
            ],
            "Komunikasi": [
                { name: "Menyimak", berk: "Mendengarkan secara aktif sejumlah teks lisan sederhana yang dipilih untuk mendapatkan informasi eksplisit dan implisit.", cakap: "Mendengarkan secara aktif sejumlah teks lisan sederhana yang dipilih untuk mendapatkan informasi eksplisit dan implisit, dan memberikan tanggapan sederhana.", mahir: "Mendengarkan secara aktif sejumlah teks lisan sederhana yang dipilih untuk mendapatkan informasi eksplisit dan implisit, dan memberikan tanggapan sederhana dan kritis." },
                { name: "Berbicara", berk: "Menyampaikan, menggali, dan menanggapi secara lisan berbagai jenis informasi melalui teks lisan sederhana namun belum tepat dan lancar.", cakap: "Menyampaikan, menggali, dan menanggapi secara lisan berbagai jenis informasi melalui teks lisan sederhana secara cukup tepat, lancar, dan efektif.", mahir: "Menyampaikan, menggali, dan menanggapi secara lisan berbagai jenis informasi melalui teks tertulis sederhana secara benar, tepat, lancar, dan efektif." },
                { name: "Membaca", berk: "Membaca secara aktif sejumlah teks tertulis sederhana yang dipilih untuk mendapatkan informasi eksplisit dan implisit.", cakap: "Membaca secara aktif sejumlah teks tertulis sederhana yang dipilih untuk mendapatkan informasi eksplisit dan implisit, dan memberikan tanggapan sederhana.", mahir: "Membaca secara aktif sejumlah teks tertulis sederhana yang dipilih untuk mendapatkan informasi eksplisit dan implisit, dan memberikan tanggapan sederhana dan kritis." },
                { name: "Menulis", berk: "Menyampaikan, menggali, dan menanggapi secara lisan berbagai jenis informasi melalui teks tertulis sederhana namun belum tepat dan lancar.", cakap: "Menyampaikan, menggali, dan menanggapi secara lisan berbagai jenis informasi melalui teks tertulis sederhana secara cukup tepat, lancar, dan efektif.", mahir: "Menyampaikan, menggali, dan menanggapi secara lisan berbagai jenis informasi melalui teks tertulis sederhana secara benar, tepat, lancar, dan efektif." }
            ]
        };
        const dimensiProfil = ["Keimanan & Ketakwaan", "Kewargaan", "Penalaran Kritis", "Kreativitas", "Kolaborasi", "Kemandirian", "Kesehatan", "Komunikasi"];
        const capaianOptions = { "M": "Mahir", "C": "Cakap", "B": "Berkembang" };
        const capaianToNumber = { "M": 3, "C": 2, "B": 1 };
        const numberToCapaian = { 3: 'M', 2: 'C', 1: 'B' };

        let activeModal = null;
        let lastFocusedElement = null;

        // --- DOM ELEMENTS ---
        const DOMElements = {
            tabNav: document.getElementById('tab-nav'),
            tabContents: { 
                identitas: document.getElementById('identitas-content'),
                perancangan: document.getElementById('perancangan-content'), 
                murid: document.getElementById('murid-content'),
                asesmen: document.getElementById('asesmen-content'), 
                hasil: document.getElementById('hasil-content') 
            },
            kegiatanContainer: document.getElementById('kegiatan-container'),
            btnTambahKegiatan: document.getElementById('tambah-kegiatan'),
            btnSaveTemplate: document.getElementById('save-template-btn'),
            btnExportData: document.getElementById('export-data-btn'),
            btnImportData: document.getElementById('import-data-btn'),
            importFileInput: document.getElementById('import-file-input'),
            templates: { 
                kegiatan: document.getElementById('kegiatan-template'), 
                dimensi: document.getElementById('dimensi-template'),
                subdimensi: document.getElementById('subdimensi-item-template')
            },
            panduanBtn: document.getElementById('panduan-btn'),
            panduanModal: document.getElementById('panduan-modal'),
            closePanduanBtn: document.getElementById('close-panduan-btn'),
            profilBtn: document.getElementById('profil-btn'),
            profilModal: document.getElementById('profil-modal'),
            closeProfilBtn: document.getElementById('close-profil-btn'),
            btnClearState: document.getElementById('clear-state-btn'),
            konfirmasiModal: document.getElementById('konfirmasi-modal'),
            konfirmasiMessage: document.getElementById('konfirmasi-message'),
            konfirmasiConfirmBtn: document.getElementById('konfirmasi-confirm-btn'),
            konfirmasiCancelBtn: document.getElementById('konfirmasi-cancel-btn'),
            notifikasiModal: document.getElementById('notifikasi-modal'),
            notifikasiMessage: document.getElementById('notifikasi-message'),
            notifikasiOkBtn: document.getElementById('notifikasi-ok-btn'),
            eksporLaporanModal: document.getElementById('ekspor-laporan-modal'),
            closeEksporLaporanBtn: document.getElementById('close-ekspor-laporan-btn'),
            exportToExcelBtn: document.getElementById('export-to-excel-btn'),
            exportToPdfBtn: document.getElementById('export-to-pdf-btn'),
            btnBackup: document.getElementById('backup-btn'),
            btnRestore: document.getElementById('restore-btn'),
            restoreFileInput: document.getElementById('restore-file-input'),
        };

        // --- GEMINI API FUNCTION ---
        // FUNGSI INI SEKARANG DIGUNAKAN UNTUK MENGIRIM PROMPT GENERATE NARASI KE GEMINI
        const callGeminiAPI = async (prompt, maxRetries = 3) => {
            const apiKey = identitasData.geminiApiKey || "";
            if (!apiKey) {
                // Notifikasi sudah ditangani di generateAINarrative jika apiKey kosong
                throw new Error("API Key Gemini belum dimasukkan.");
            }
            // Menggunakan model yang lebih stabil untuk tugas non-streaming dan non-grounding
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            // Perubahan pada System Prompt untuk menegaskan format dan gaya bahasa yang diminta
            const systemPrompt = "Anda adalah seorang guru ahli yang bertugas menulis deskripsi rapor kokurikuler untuk siswa sekolah dasar di Indonesia. Munculkan informasi tentang dimensi terkait, tebalkan bagian ini, jangan dikapitalkan. Munculkan juga uraian capaian kompetensi berdasar hasil asesmen pada tab asesmen secara ringkas dengan kalimat yang natural tidak kaku. Gunakan bahasa yang positif, membangun, dan mudah dipahami oleh orang tua. Fokus pada kekuatan siswa dan berikan saran yang konstruktif untuk area yang perlu ditingkatkan. Selalu sebut nama siswa di awal narasi, awali ungkapan dengan kata Ananda. Ketika dibutuhkan sapaan pada kalimat berikutnya hindari penulisan nama langsung, selalu awali dengan Ananda ketika diperlukan Buatlah narasi yang mengalir alami dalam satu paragraf (sekitar 70-100 kata), hindari format daftar atau poin-poin. Hindari penggunaan kosa kata namun, akan tetapi, meskipun, dan sejenisnya, gunakan frase dengan nuansa yang lebih lembut, positif, dan membangun, cocok untuk narasi pendidikan atau laporan perkembangan peserta didik. Sesuaikan kaidah bacaan, tanda baca, kapitalisasi, tanda hubung, kata hubung, dan kaidah bahasa lainnya. Jangan kapitalkan huruf di tengah kalimat yang tidak sesuai kaidah PUEBI. Akhiri paragraf dengan memberikan kalimat motivasi membangun yang sesuai dengan keadaan. Jawab selalu dalam format JSON tanpa teks tambahan.";

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "narasi": { "type": "STRING", "description": "Narasi rapor yang komprehensif, inspiratif, dan padat." }
                        },
                        required: ["narasi"]
                    }
                }
            };

            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) {
                        throw new Error(`API Error 429: Too many requests.`);
                    }
                    if (!response.ok) {
                        const errorBody = await response.json();
                        console.error("API call failed with non-ok status:", errorBody);
                        throw new Error(`Gagal menghubungi AI. Status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    const rawText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (!rawText) {
                        throw new Error("Respon dari AI kosong atau tidak valid.");
                    }
                    
                    const jsonMatch = rawText.match(/```json\s*([\s\S]*?)\s*```|(\[[\s\S]*\])|({[\s\S]*})/);
                    const jsonString = jsonMatch?.[1] || jsonMatch?.[2] || jsonMatch?.[3] || rawText;

                    const parsedJson = JSON.parse(jsonString);
                    return parsedJson.narasi;

                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                    attempt++;
                    if (attempt >= maxRetries) {
                        // Tidak menampilkan notifikasi di sini agar generateAIAll hanya menampilkan notifikasi akhir
                        throw error;
                    }
                    const delay = Math.pow(2, attempt) * 1000; // 1s, 2s, 4s
                    await new Promise(res => setTimeout(res, delay));
                }
            }
        };


        // --- FUNCTIONS DEFINITION ---

        const getFormattedTimestamp = (full = false) => {
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const hh = String(now.getHours()).padStart(2, '0');
            const min = String(now.getMinutes()).padStart(2, '0');
            const ss = String(now.getSeconds()).padStart(2, '0');
            if (full) return `${yyyy}${mm}${dd}_${hh}${min}${ss}`;
            return `${yyyy}${mm}${dd}_${hh}${min}`;
        };

        const saveState = () => {
            try {
                simpanIdentitas();
                simpanPerancangan();
                simpanAsesmen(currentAsesmenViewId);
                const state = { identitasData, kegiatanData, muridData, daftarMurid, isIdentitasComplete };
                localStorage.setItem('raporKokurikulerState', JSON.stringify(state));
            } catch (e) {
                console.error("Gagal menyimpan state ke localStorage:", e);
            }
        };

        const loadState = () => {
            try {
                const savedState = localStorage.getItem('raporKokurikulerState');
                if (savedState) {
                    const state = JSON.parse(savedState);
                    identitasData = state.identitasData || {};
                    kegiatanData = state.kegiatanData || {};
                    muridData = state.muridData || {};
                    daftarMurid = state.daftarMurid || [];
                    isIdentitasComplete = state.isIdentitasComplete || false;
                    muridHistory = [[...daftarMurid]];
                    muridHistoryIndex = 0;
                    identitasHistory = [JSON.parse(JSON.stringify(identitasData))];
                    identitasHistoryIndex = 0;
                    perancanganHistory = [JSON.parse(JSON.stringify(kegiatanData || {}))];
                    perancanganHistoryIndex = 0;
                    return true;
                }
            } catch (e) {
                console.error("Gagal memuat state dari localStorage:", e);
                localStorage.removeItem('raporKokurikulerState');
            }
            return false;
        };
        
        const openModal = (modalElement) => {
            lastFocusedElement = document.activeElement;
            modalElement.classList.remove('hidden');
            activeModal = modalElement;
            const firstFocusable = modalElement.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            if (firstFocusable) {
                firstFocusable.focus();
            }
        };

        // --- PERBAIKAN KRITIS UNTUK MEMASTIKAN MODAL TERTUTUP ---
        const closeModal = () => {
            // Periksa dan tutup modal konfirmasi jika masih terbuka (ini adalah modal utama yang bermasalah)
            if (DOMElements.konfirmasiModal && !DOMElements.konfirmasiModal.classList.contains('hidden')) {
                DOMElements.konfirmasiModal.classList.add('hidden');
                // Penting: Hapus listener yang tersisa untuk menghindari konflik
                if (DOMElements.konfirmasiConfirmBtn.confirmHandler) {
                    DOMElements.konfirmasiConfirmBtn.removeEventListener('click', DOMElements.konfirmasiConfirmBtn.confirmHandler);
                    delete DOMElements.konfirmasiConfirmBtn.confirmHandler;
                }
                if (DOMElements.konfirmasiCancelBtn.cancelHandler) {
                     DOMElements.konfirmasiCancelBtn.removeEventListener('click', DOMElements.konfirmasiCancelBtn.cancelHandler);
                     delete DOMElements.konfirmasiCancelBtn.cancelHandler;
                }
            }

            // Lanjutkan dengan logika closeModal yang asli (untuk modal lain seperti panduan/profil)
            if (activeModal) {
                activeModal.classList.add('hidden');
                activeModal = null;
                if (lastFocusedElement) {
                    lastFocusedElement.focus();
                }
            }
        };
        // ---------------------------------------------------------

        const showNotification = (message) => {
            DOMElements.notifikasiMessage.textContent = message;
            openModal(DOMElements.notifikasiModal);
        };

        const showConfirmation = (message, onConfirm) => {
            DOMElements.konfirmasiMessage.textContent = message;
            openModal(DOMElements.konfirmasiModal);

            // Fungsi penutup modal, dilepas dari listener
            const hideConfirmation = () => {
                closeModal(); // Memanggil closeModal yang sudah diperbarui
            };
            
            // Handler untuk tombol Ya, Lanjutkan
            const confirmHandler = () => {
                try {
                    onConfirm();
                } catch (error) {
                    console.error("Error saat menjalankan fungsi konfirmasi:", error);
                    showNotification(`Terjadi kesalahan saat melanjutkan aksi: ${error.message}`);
                } finally {
                    // Pastikan modal selalu tertutup
                    hideConfirmation();
                }
            };

            // Handler untuk tombol Batal
            const cancelHandler = () => {
                // Tombol Batal hanya perlu menutup dialog
                hideConfirmation(); 
            };

            // Bersihkan listeners sebelumnya (Pengecekan keberadaan handler sebelum menghapus)
            if (DOMElements.konfirmasiConfirmBtn.confirmHandler) {
                DOMElements.konfirmasiConfirmBtn.removeEventListener('click', DOMElements.konfirmasiConfirmBtn.confirmHandler);
                delete DOMElements.konfirmasiConfirmBtn.confirmHandler;
            }
            if (DOMElements.konfirmasiCancelBtn.cancelHandler) {
                 DOMElements.konfirmasiCancelBtn.removeEventListener('click', DOMElements.konfirmasiCancelBtn.cancelHandler);
                 delete DOMElements.konfirmasiCancelBtn.cancelHandler;
            }

            // Simpan handler di elemen untuk referensi penghapusan (cleaning up)
            DOMElements.konfirmasiConfirmBtn.confirmHandler = confirmHandler;
            DOMElements.konfirmasiCancelBtn.cancelHandler = cancelHandler;
            
            // Tambahkan listener baru
            DOMElements.konfirmasiConfirmBtn.addEventListener('click', confirmHandler);
            DOMElements.konfirmasiCancelBtn.addEventListener('click', cancelHandler);
        };

        const updateTabLockState = () => {
            const tabsToLock = DOMElements.tabNav.querySelectorAll('[data-tab]:not([data-tab="identitas"])');
            if (isIdentitasComplete) {
                tabsToLock.forEach(tab => {
                    const wrapper = tab.parentElement;
                    tab.disabled = false;
                    tab.classList.remove('opacity-50');
                    tab.setAttribute('tabindex', '0');
                    const tooltip = wrapper.querySelector('.tooltip');
                    if (tooltip) tooltip.innerHTML = '';
                });
            } else {
                tabsToLock.forEach(tab => {
                    const wrapper = tab.parentElement;
                    tab.disabled = true;
                    tab.classList.add('opacity-50');
                    tab.setAttribute('tabindex', '-1');
                    const tooltip = wrapper.querySelector('.tooltip');
                    if (tooltip) tooltip.innerHTML = 'Tab ini terkunci, akan aktif setelah tab identitas terisi dan tersimpan.';
                });
            }
        };

        const clearState = () => {
            const message = "Apakah Anda yakin ingin menghapus semua data Perencanaan dan Asesmen? Data Identitas dan Daftar Murid tidak akan terhapus. Tindakan ini tidak dapat diurungkan.";
            showConfirmation(message, () => {
                // Hanya reset data perencanaan dan asesmen
                kegiatanData = {};
                muridData = {}; 
                perancanganHistory = [{}];
                perancanganHistoryIndex = 0;
                
                renderFromState(); // Render ulang tab perencanaan (akan menampilkan kartu kosong)
                saveState(); // Simpan state yang sudah diubah
                showNotification("Data Perencanaan dan Asesmen berhasil dihapus. Data Identitas dan Murid Anda tetap aman.");
            });
        };

        const showTab = (tabId) => {
            saveState();
            activeTab = tabId;
            Object.values(DOMElements.tabContents).forEach(content => {
                content.classList.add('hidden');
            });
            DOMElements.tabNav.querySelectorAll('[role="tab"]').forEach(b => {
                 b.classList.remove('tab-active', 'text-slate-500');
                 b.setAttribute('aria-selected', 'false');
                 b.setAttribute('tabindex', '-1');
            });
            
            if (DOMElements.tabContents[tabId]) {
                 DOMElements.tabContents[tabId].classList.remove('hidden');
            }

            const activeButton = DOMElements.tabNav.querySelector(`[data-tab="${tabId}"]`);
            activeButton.classList.add('tab-active');
            activeButton.setAttribute('aria-selected', 'true');
            activeButton.setAttribute('tabindex', '0');
            DOMElements.tabNav.querySelectorAll('[role="tab"]').forEach(b => {
                if (!b.classList.contains('tab-active')) b.classList.add('text-slate-500');
            });
            
            if (tabId === 'identitas') renderIdentitasPage();
            if (tabId === 'murid') renderMuridPage();
            if (tabId === 'perancangan') {
                renderFromState();
                updateUndoRedoButtonsPerancangan();
            }
            if (tabId === 'asesmen') renderAsesmenPage(); 
            if (tabId === 'hasil') renderHasilPage();
        };

        // NEW function for rendering Subdimensi checkboxes
        const renderSubdimensiCheckboxes = (dimensiBlock, dimensionName, initialData = []) => {
            const container = dimensiBlock.querySelector('.subdimensi-container');
            container.innerHTML = '<p class="text-xs text-slate-500 font-semibold mb-2">Pilih satu atau lebih Subdimensi fokus:</p>';
            
            const subdims = subdimensiDetail[dimensionName] || [];
            subdims.forEach(sub => {
                const subId = sub.name.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
                const clone = DOMElements.templates.subdimensi.content.cloneNode(true);
                const item = clone.querySelector('.subdimensi-item');
                const checkbox = item.querySelector('.subdimensi-checkbox');
                const descDiv = item.querySelector('.subdimensi-capaian');
                
                item.dataset.subdimensiId = subId;
                item.dataset.subdimensiName = sub.name;
                checkbox.id = `subdim-${dimensionName}-${subId}`;
                checkbox.name = subId;
                
                item.querySelector('.subdimensi-name').textContent = sub.name;
                // FIX START: Correcting template literal syntax
                item.querySelector('.berk-desc').innerHTML = `<strong>Berkembang:</strong> ${sub.berk}`;
                item.querySelector('.cakap-desc').innerHTML = `<strong>Cakap:</strong> ${sub.cakap}`;
                item.querySelector('.mahir-desc').innerHTML = `<strong>Mahir:</strong> ${sub.mahir}`;
                // FIX END
                
                const isChecked = initialData.some(d => d.name === sub.name);
                if (isChecked) {
                    checkbox.checked = true;
                    descDiv.classList.remove('hidden');
                }

                checkbox.addEventListener('change', () => {
                    descDiv.classList.toggle('hidden', !checkbox.checked);
                    captureAndSavePerancanganState();
                });

                // Toggle visibility when clicking the main area (not just checkbox)
                item.querySelector('.subdimensi-name').closest('label').addEventListener('click', (e) => {
                    if (e.target.tagName !== 'INPUT') {
                        e.preventDefault(); 
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change'));
                    }
                });

                container.appendChild(clone);
            });
        };

        // Modified tambahDimensi (Removed Tujuan/Aspek logic)
        const tambahDimensi = (button, data = null, container = null) => {
            container = container || button.closest('.tooltip-container').previousElementSibling;
            const clone = DOMElements.templates.dimensi.content.cloneNode(true);
            const block = clone.querySelector('.dimensi-block');
            const select = block.querySelector('.dimensi-select');
            select.innerHTML = '<option value="">-- Pilih Dimensi --</option>';
            dimensiProfil.forEach(dim => select.innerHTML += `<option value="${dim}">${dim}</option>`);
            
            if (data) select.value = data.name;

            const initialSubdims = data && data.subdims ? data.subdims : [];

            // Add listener for dimension change
            select.addEventListener('change', () => {
                const selectedDim = select.value;
                renderSubdimensiCheckboxes(block, selectedDim, []);
                captureAndSavePerancanganState();
            });

            if (data) {
                renderSubdimensiCheckboxes(block, data.name, initialSubdims);
            }

            container.appendChild(clone);
        };

        const tambahKegiatan = (openByDefault = false, data = null) => {
            const clone = DOMElements.templates.kegiatan.content.cloneNode(true);
            const card = clone.querySelector('.kegiatan-card');
            const cardId = data ? data.id : `kegiatan-${Date.now()}`;
            card.dataset.id = cardId;

            const header = card.querySelector('.kegiatan-header');
            const body = card.querySelector('.kegiatan-body');
            const bodyId = `kegiatan-body-${cardId}`;
            header.setAttribute('aria-controls', bodyId);
            header.setAttribute('aria-expanded', openByDefault);
            body.id = bodyId;

            const nameInput = card.querySelector('.nama-kegiatan');
            nameInput.value = data ? data.name : '';
            const dimensiContainer = card.querySelector('.dimensi-container');
            if (data && data.dims) {
                Object.entries(data.dims).forEach(([dimId, dimData]) => {
                    tambahDimensi(null, { ...dimData, id: dimId }, dimensiContainer);
                });
            } else {
                tambahDimensi(card.querySelector('.tambah-dimensi'));
            }
            DOMElements.kegiatanContainer.appendChild(clone);
            const newCard = DOMElements.kegiatanContainer.querySelector(`[data-id="${cardId}"]`);
            if (openByDefault) {
                const bodyEl = newCard.querySelector('.kegiatan-body');
                const icon = newCard.querySelector('.toggle-icon');
                bodyEl.classList.add('open');
                icon.classList.add('rotate-180');
            }
        };
        
        const renderFromState = () => {
            if (!DOMElements.kegiatanContainer) return;
            DOMElements.kegiatanContainer.innerHTML = '';
            if (Object.keys(kegiatanData).length > 0) {
                Object.entries(kegiatanData).forEach(([id, data]) => {
                    tambahKegiatan(false, { id, ...data });
                });
            } else {
                tambahKegiatan(true);
            }
        };

        // Modified handleSaveTemplate
        const handleSaveTemplate = () => {
            const workbook = XLSX.utils.book_new();
            const petunjukData = [
                ["PANDUAN PENGISIAN TEMPLATE RENCANA"], [],
                ["Kolom Penjelasan:"],
                ["ID_Kegiatan", "Kode unik untuk setiap kegiatan. Gunakan ID yang SAMA untuk semua baris dalam satu kegiatan."],
                ["Nama_Kegiatan", "Nama lengkap kegiatan. Gunakan nama yang SAMA untuk semua baris dalam satu kegiatan."],
                ["ID_Dimensi", "Kode unik untuk setiap dimensi. Gunakan ID yang SAMA untuk semua subdimensi di bawah dimensi yang sama."],
                ["Nama_Dimensi", "Pilih dari daftar dropdown yang tersedia."],
                ["ID_Subdimensi", "Kode unik Subdimensi. Tujuannya sebagai pengenal."],
                ["Nama_Subdimensi", "Nama Subdimensi yang dipilih. Harus sesuai dengan daftar Subdimensi di Sheet 'DaftarSubdimensi'."]
            ];
            
            const wsPetunjuk = XLSX.utils.aoa_to_sheet(petunjukData);
            wsPetunjuk['!cols'] = [ {wch: 25}, {wch: 100} ];
            XLSX.utils.book_append_sheet(workbook, wsPetunjuk, 'Petunjuk Pengisian');

            // Add Subdimensi list sheet
            const listSheetName = 'DaftarSubdimensi';
            const listData = [['Dimensi', 'Subdimensi']];
            Object.entries(subdimensiDetail).forEach(([dimName, subdims]) => {
                subdims.forEach(sub => listData.push([dimName, sub.name]));
            });
            const wsList = XLSX.utils.aoa_to_sheet(listData);
            XLSX.utils.book_append_sheet(workbook, wsList, listSheetName);

            const rows = [['ID_Kegiatan', 'Nama_Kegiatan', 'ID_Dimensi', 'Nama_Dimensi', 'ID_Subdimensi', 'Nama_Subdimensi']];
            const exampleSubdim = subdimensiDetail['Penalaran Kritis'][0];
            const exampleRows = [
                ['keg1', 'Proyek "Lingkunganku Bersih"', 'k1d1', 'Penalaran Kritis', 'k1d1sd1', exampleSubdim.name],
                ['keg1', 'Proyek "Lingkunganku Bersih"', 'k1d2', 'Kolaborasi', 'k1d2sd1', subdimensiDetail['Kolaborasi'][0].name],
            ];
            rows.push(...exampleRows);

            const wsPerencanaan = XLSX.utils.aoa_to_sheet(rows);
            wsPerencanaan['!cols'] = [ {wch: 20}, {wch: 30}, {wch: 15}, {wch: 20}, {wch: 20}, {wch: 40} ];
            XLSX.utils.book_append_sheet(workbook, wsPerencanaan, 'Perencanaan');

            // Hide Subdimensi list sheet
            if (!workbook.Workbook) workbook.Workbook = { Sheets: [] };
            else if (!workbook.Workbook.Sheets) workbook.Workbook.Sheets = [];
            
            const subdimSheetIndex = workbook.SheetNames.indexOf(listSheetName);
            if(subdimSheetIndex > -1) {
                 workbook.Workbook.Sheets[subdimSheetIndex] = { Name: listSheetName, Hidden: 1 };
            }

            const filename = `Edi Brata_Kokurikuler_Perencanaan_Template_${getFormattedTimestamp(true)}.xlsx`;
            XLSX.writeFile(workbook, filename);
            showNotification("Template Perencanaan berhasil diunduh.");
        };
        
        // Modified handleExportData
        const handleExportData = () => {
            saveState();
            if (Object.keys(kegiatanData).length === 0) { 
                showNotification('Tidak ada data perencanaan untuk diekspor. Silakan buat perencanaan di tab "Perencanaan" terlebih dahulu.'); 
                return; 
            }
            const planningRows = [['ID_Kegiatan', 'Nama_Kegiatan', 'ID_Dimensi', 'Nama_Dimensi', 'ID_Subdimensi', 'Nama_Subdimensi']];
            Object.entries(kegiatanData).forEach(([kegiatanId, kegiatan]) => {
                Object.entries(kegiatan.dims).forEach(([dimId, dim]) => {
                    dim.subdims.forEach(subdim => {
                        planningRows.push([
                            kegiatanId, kegiatan.name, dimId, dim.name, subdim.id, subdim.name
                        ]);
                    });
                });
            });
            const wsPlanning = XLSX.utils.aoa_to_sheet(planningRows);
             wsPlanning['!cols'] = [ {wch: 20}, {wch: 30}, {wch: 15}, {wch: 20}, {wch: 20}, {wch: 40} ];

            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, wsPlanning, 'Perencanaan');

            const filename = `Edi Brata_Kokurikuler_Perencanaan_Ekspor_${getFormattedTimestamp(true)}.xlsx`;
            XLSX.writeFile(workbook, filename);
        };

        // Modified processImportedFile
        const processImportedFile = (event) => {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const workbook = XLSX.read(e.target.result, { type: 'array' });
                    const wsPlanning = workbook.Sheets['Perencanaan'];
                    if (!wsPlanning) throw new Error("Sheet 'Perencanaan' tidak ditemukan. Pastikan file Anda memiliki sheet dengan nama ini.");
                    
                    const planningJson = XLSX.utils.sheet_to_json(wsPlanning, { header: 1 });
                    const newKegiatanData = {};
                    let processedRows = 0;
                    
                    planningJson.slice(1).forEach(row => {
                        if (!row || row.length < 6) return;
                        const [kegiatanId, namaKegiatan, dimId, namaDimensi, subdimId, namaSubdimensi] = row.map(cell => (cell !== null && cell !== undefined) ? String(cell).trim() : '');

                        if (!kegiatanId || !namaKegiatan || !dimId || !namaDimensi || !namaSubdimensi) return;
                        
                        processedRows++;
                        if (!newKegiatanData[kegiatanId]) newKegiatanData[kegiatanId] = { name: namaKegiatan, dims: {} };
                        if (!newKegiatanData[kegiatanId].dims[dimId]) newKegiatanData[kegiatanId].dims[dimId] = { name: namaDimensi, subdims: [] };
                        
                        // Check for duplicate subdimensi within the dimension
                        const isDuplicate = newKegiatanData[kegiatanId].dims[dimId].subdims.some(s => s.name === namaSubdimensi);
                        
                        if (!isDuplicate) {
                            newKegiatanData[kegiatanId].dims[dimId].subdims.push({
                                id: subdimId || `sd-${kegiatanId.slice(-4)}-${processedRows}`, // Use original ID or generate a fallback
                                name: namaSubdimensi
                            });
                        }
                    });

                    kegiatanData = newKegiatanData;
                    muridData = {}; // Reset assessment data as planning has changed

                    if (processedRows === 0) {
                         showNotification('Tidak ada data valid yang ditemukan dalam file. Pastikan Anda telah mengisi semua kolom yang diperlukan.');
                    } else {
                         showNotification(`Data berhasil diimpor!\n${processedRows} baris perencanaan kegiatan dimuat.`);
                    }
                    
                    // Save to history
                    perancanganHistory = perancanganHistory.slice(0, perancanganHistoryIndex + 1);
                    perancanganHistory.push(JSON.parse(JSON.stringify(kegiatanData)));
                    perancanganHistoryIndex = perancanganHistory.length - 1;

                    renderFromState();
                    updateUndoRedoButtonsPerancangan();
                    saveState();
                } catch (error) {
                    showNotification(`Gagal memuat file: ${error.message}`);
                    console.error("Import error:", error);
                }
            };
            reader.readAsArrayBuffer(file);
            event.target.value = null;
        };
        
        // Modified simpanPerancangan
        const simpanPerancangan = () => {
            const newKegiatanData = {};
            if(!DOMElements.kegiatanContainer) return;
            DOMElements.kegiatanContainer.querySelectorAll('.kegiatan-card').forEach((card) => {
                const id = card.dataset.id;
                const name = card.querySelector('.nama-kegiatan').value || `Kegiatan Tanpa Nama`;
                newKegiatanData[id] = { name: name, dims: {} };
                card.querySelectorAll('.dimensi-block').forEach((block, dimIndex) => {
                    const dimName = block.querySelector('.dimensi-select').value;
                    if (dimName) {
                        const subdimList = [];
                        block.querySelectorAll('.subdimensi-item').forEach(subdimItem => {
                            const checkbox = subdimItem.querySelector('.subdimensi-checkbox');
                            if (checkbox.checked) {
                                subdimList.push({
                                    id: subdimItem.dataset.subdimensiId,
                                    name: subdimItem.dataset.subdimensiName
                                });
                            }
                        });

                        if (subdimList.length > 0) {
                            const dimId = `dim-${id.split('-')[1]}-${String.fromCharCode(97 + dimIndex)}`;
                            newKegiatanData[id].dims[dimId] = { name: dimName, subdims: subdimList };
                        }
                    }
                });
            });
            kegiatanData = newKegiatanData;
        };

        // Modified handleExportAsesmen
        const handleExportAsesmen = () => {
            saveState();
            if (Object.keys(muridData).length === 0) {
                showNotification('Tidak ada nilai asesmen yang tersimpan untuk diekspor. Silakan isi asesmen terlebih dahulu.');
                return;
            }

            const workbook = XLSX.utils.book_new();

            Object.entries(kegiatanData).forEach(([kegiatanId, kegiatan]) => {
                const studentsInThisActivity = daftarMurid.filter(nama => muridData[nama] && muridData[nama][kegiatanId]);
                if (studentsInThisActivity.length === 0) return;

                const sheetName = sanitizeSheetName(kegiatan.name);
                const headers = ['Nama Murid'];
                const subdimensiMap = []; 

                Object.entries(kegiatan.dims).forEach(([dimId, dim]) => {
                    dim.subdims.forEach((subdim, subdimIndex) => {
                        headers.push(subdim.name);
                        subdimensiMap.push({ dimId, subdimIndex, subdimName: subdim.name });
                    });
                });
                
                const rows = [headers];
                studentsInThisActivity.forEach(nama => {
                    const row = [nama];
                    subdimensiMap.forEach(({ dimId, subdimIndex }) => {
                        const capaianKey = muridData[nama]?.[kegiatanId]?.[dimId]?.[subdimIndex];
                        const capaianNumber = capaianToNumber[capaianKey];
                        // Export M/C/B as 3/2/1
                        row.push(capaianNumber !== undefined ? capaianNumber : '');
                    });
                    rows.push(row);
                });

                if (rows.length > 1) {
                    const ws = XLSX.utils.aoa_to_sheet(rows);
                    ws['!cols'] = [{ wch: 25 }].concat(headers.slice(1).map(() => ({ wch: 20 })));
                    XLSX.utils.book_append_sheet(workbook, ws, sheetName);
                }
            });

            if (workbook.SheetNames.length === 0) {
                showNotification('Tidak ditemukan data asesmen yang terisi untuk diekspor.');
                return;
            }

            const filename = `Edi Brata_Kokurikuler_Asesmen_Ekspor_${getFormattedTimestamp(true)}.xlsx`;
            XLSX.writeFile(workbook, filename);
        };

        // Modified handleImportAsesmen
        const handleImportAsesmen = (event) => {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const workbook = XLSX.read(e.target.result, { type: 'array' });
                    let importedSheetCount = 0; // Temp counter for sheet loop
                    
                    // Use existing daftarMurid or initialize from the first sheet if needed
                    let newMasterMuridList = new Set(daftarMurid); 
                    
                    workbook.SheetNames.forEach(sheetName => {
                        // Skip system sheets
                        if (sheetName === 'Petunjuk' || sheetName === 'Daftar Nama Murid' || sheetName === 'DaftarSubdimensi') return;

                        // Find the corresponding activity in the current planning data
                        const kegiatan = Object.entries(kegiatanData).find(([id, keg]) => sanitizeSheetName(keg.name) === sheetName);
                        if (!kegiatan) return;

                        const kegiatanId = kegiatan[0];
                        const ws = workbook.Sheets[sheetName];
                        const sheetData = XLSX.utils.sheet_to_json(ws, { header: 1 });
                        
                        if (!sheetData || sheetData.length < 1) return;
                        const headers = sheetData[0].map(h => String(h || '').trim());
                        const subdimensiMap = [];
                         
                         // Build Subdimensi Map based on the planning data
                         Object.entries(kegiatanData[kegiatanId].dims).forEach(([dimId, dim]) => {
                            dim.subdims.forEach((subdim, subdimIndex) => {
                                // Find the column index of this subdimensi in the imported sheet
                                const headerIndex = headers.indexOf(String(subdim.name).trim());
                                if(headerIndex > -1) {
                                    subdimensiMap.push({ headerIndex, dimId, subdimIndex });
                                }
                            });
                        });
                        
                        let importedStudentCount = 0; // Temp counter for student loop
                        sheetData.slice(1).forEach(row => {
                            const nama = String(row[0] || '').trim();
                            if (!nama) return;
                            
                            newMasterMuridList.add(nama);
                            if (!muridData[nama]) muridData[nama] = {};
                            if (!muridData[nama][kegiatanId]) muridData[nama][kegiatanId] = {};
                            
                            subdimensiMap.forEach(({ headerIndex, dimId, subdimIndex }) => {
                                const capaianValue = String(row[headerIndex] || '').trim().toUpperCase();
                                let capaianKey = '';
                                
                                // Convert 1/2/3 to B/C/M
                                if (capaianValue === '3') capaianKey = 'M';
                                else if (capaianValue === '2') capaianKey = 'C';
                                else if (capaianValue === '1') capaianKey = 'B';
                                // Accept B/C/M directly
                                else if (capaianValue === 'M' || capaianValue === 'C' || capaianValue === 'B') capaianKey = capaianValue;

                                // Save the imported Capaian Key (M/C/B)
                                if(capaianKey) {
                                    if (!muridData[nama][kegiatanId][dimId]) muridData[nama][kegiatanId][dimId] = [];
                                    muridData[nama][kegiatanId][dimId][subdimIndex] = capaianKey;
                                }
                            });
                            importedStudentCount++;
                        });
                        
                        if(importedSheetCount > 0) {
                            importedSheetCount++;
                        }
                    });

                    // Update daftarMurid and history
                    muridHistory = muridHistory.slice(0, muridHistoryIndex + 1);
                    const newList = Array.from(newMasterMuridList).sort((a,b) => a.localeCompare(b));
                    muridHistory.push(newList);
                    muridHistoryIndex = muridHistory.length - 1;
                    daftarMurid = [...newList];

                    if (importedSheetCount > 0) {
                        const message = `Impor berhasil! Data asesmen dari ${importedSheetCount} sheet kegiatan telah dimuat. Daftar murid juga telah diperbarui.`;
                        showNotification(message);
                        renderAsesmenTable(); // Render UI with new data
                        updateUndoRedoButtons(); 
                        saveState(); 
                    } else {
                        showNotification('Tidak ada nama sheet di file Excel yang cocok dengan nama kegiatan yang ada di aplikasi, atau sheet yang ada kosong.');
                    }
                } catch (error) {
                    showNotification(`Gagal memuat file: ${error.message}`);
                    console.error("Import Asesmen Error:", error);
                }
            };
            
            reader.readAsArrayBuffer(file);
            event.target.value = null; 
        };

        // Modified simpanAsesmen
        const simpanAsesmen = (kegiatanIdToSave) => {
            if (!kegiatanIdToSave) return;
            const asesmenTable = document.getElementById('asesmen-tbody');
            if (!asesmenTable) return;

            asesmenTable.querySelectorAll('tr').forEach(row => {
                const nama = row.dataset.namaMurid;
                if (nama) {
                    if (!muridData[nama]) muridData[nama] = {};
                    if (!muridData[nama][kegiatanIdToSave]) muridData[nama][kegiatanIdToSave] = {};
                    
                    row.querySelectorAll('.capaian').forEach(select => {
                        const { dimId, subdimIndex } = select.dataset;
                        if (!muridData[nama][kegiatanIdToSave][dimId]) muridData[nama][kegiatanIdToSave][dimId] = [];
                        muridData[nama][kegiatanIdToSave][dimId][parseInt(subdimIndex)] = select.value;
                    });
                }
            });
        };

        // Modified tambahBarisMuridAsesmen
        const tambahBarisMuridAsesmen = (tbody, nama) => {
            if (!tbody || !nama) return;
            const selectedId = document.getElementById('asesmen-kegiatan-select').value;
            if (!kegiatanData[selectedId] || !kegiatanData[selectedId].dims) return;
            
            const data = kegiatanData[selectedId];
            const row = document.createElement('tr');
            row.className = 'border-b';
            row.dataset.namaMurid = nama;
            
            let cellsHTML = `<td class="px-4 py-2 font-medium text-slate-700 bg-slate-50">${nama}</td>`;
            Object.entries(data.dims).forEach(([dimId, dimData]) => {
                dimData.subdims.forEach((_, subdimIndex) => {
                    const savedVal = muridData[nama]?.[selectedId]?.[dimId]?.[subdimIndex] || 'C'; // Default to Cakap
                    cellsHTML += `<td class="px-2 py-2 border-l"><select data-dim-id="${dimId}" data-subdim-index="${subdimIndex}" class="capaian w-full p-2 border rounded">${Object.entries(capaianOptions).map(([v,t])=>`<option value="${v}" ${savedVal===v ? 'selected':''}>${t}</option>`).join('')}</select></td>`;
                });
            });
            row.innerHTML = cellsHTML;
            tbody.appendChild(row);
        };
        
        const sanitizeSheetName = (name) => {
            return name.replace(/[/\\?*[\]]/g, '').substring(0, 31);
        };

        // Modified handleDownloadAsesmenTemplate
        const handleDownloadAsesmenTemplate = (type, action = 'template') => {
            saveState();
            const workbook = XLSX.utils.book_new();
            const timestamp = getFormattedTimestamp(true);

            if (type === 'semua') {
                if (Object.keys(kegiatanData).length === 0) {
                    showNotification('Tidak ada kegiatan yang direncanakan. Buat perencanaan terlebih dahulu.');
                    return;
                }
                const petunjukData = [
                    ["PANDUAN PENGISIAN TEMPLATE ASESMEN"], [],
                    ["Penting:"],
                    ["1.", "Template ini dibuat berdasarkan data Perencanaan dan data Murid yang telah Anda masukkan."],
                    ["2.", "Setiap kegiatan yang memiliki Subdimensi yang dipilih akan dibuatkan dalam sheet terpisah."],
                    ["3.", "Jangan mengubah nama murid yang sudah ada di kolom A."],
                    ["4.", "Isilah kolom Subdimensi dengan angka sesuai capaian:"],
                    ["", "3 = Mahir (M)"],
                    ["", "2 = Cakap (C)"],
                    ["", "1 = Berkembang (B)"],
                    ["5.", "Setelah diisi, simpan file ini lalu impor kembali melalui tombol 'Impor' di tab Asesmen."],
                ];
                const wsPetunjuk = XLSX.utils.aoa_to_sheet(petunjukData);
                wsPetunjuk['!cols'] = [{ wch: 4 }, {wch: 100}];
                XLSX.utils.book_append_sheet(workbook, wsPetunjuk, 'Petunjuk');
                
                Object.entries(kegiatanData).forEach(([kegiatanId, kegiatan]) => {
                    const sheetName = sanitizeSheetName(kegiatan.name);
                    const headers = ['Nama Murid'];
                    const subdimsInKegiatan = [];
                    Object.values(kegiatan.dims).forEach(dim => dim.subdims.forEach(subdim => {
                        headers.push(subdim.name);
                        subdimsInKegiatan.push(subdim);
                    }));

                    if (subdimsInKegiatan.length === 0) return;
                    
                    const rows = [headers, ...daftarMurid.map(nama => [nama])];
                    const ws = XLSX.utils.aoa_to_sheet(rows);
                    ws['!cols'] = [{ wch: 25 }].concat(headers.slice(1).map(() => ({ wch: 30 })));
                    XLSX.utils.book_append_sheet(workbook, ws, sheetName);
                });

                if (workbook.SheetNames.length <= 1) {
                    showNotification('Tidak ada kegiatan dengan subdimensi yang dipilih yang bisa dibuatkan template.');
                    return;
                }
                const filename = `Edi Brata_Kokurikuler_Asesmen_Template_${timestamp}.xlsx`;
                XLSX.writeFile(workbook, filename);
                showNotification("Template Asesmen untuk semua kegiatan berhasil diunduh.");

            } else if (type === 'nama') {
                const sheetName = 'Daftar Nama Murid';
                let rows;
                if (action === 'template') {
                    rows = [['Nama Murid']]; // For template, only include the header
                } else {
                    rows = [['Nama Murid'], ...daftarMurid.map(nama => [nama])]; // For export, include all current student data
                }
                const ws = XLSX.utils.aoa_to_sheet(rows);
                ws['!cols'] = [{ wch: 30 }];
                XLSX.utils.book_append_sheet(workbook, ws, sheetName);
                const actionText = action === 'template' ? 'Data Murid_Template' : 'Data Murid_Ekspor';
                const filename = `Edi Brata_Kokurikuler_${actionText}_${getFormattedTimestamp(true)}.xlsx`;
                XLSX.writeFile(workbook, filename);
                showNotification(`Template/Ekspor Data Murid berhasil diunduh.`);
            }
        };

        // Modified renderAsesmenTable
        const renderAsesmenTable = () => {
            const container = document.getElementById('asesmen-table-container');
            const selectedId = document.getElementById('asesmen-kegiatan-select')?.value;
            if (!selectedId || !kegiatanData[selectedId] || !kegiatanData[selectedId].dims || Object.keys(kegiatanData[selectedId].dims).length === 0) {
                container.innerHTML = `<div class="text-center py-10 px-6 bg-slate-50 rounded-lg"><i class="fas fa-list-check text-4xl text-slate-400"></i><p class="mt-4 text-slate-500">Pilih kegiatan atau lengkapi data perancangan (Subdimensi) terlebih dahulu.</p></div>`;
                return;
            }
            if (daftarMurid.length === 0) {
                 container.innerHTML = `<div class="text-center py-10 px-6 bg-slate-50 rounded-lg"><i class="fas fa-users text-4xl text-slate-400"></i><p class="mt-4 text-slate-500">Daftar nama murid masih kosong. Silakan isi terlebih dahulu di tab <strong>Data Murid</strong>.</p></div>`;
                return;
            }

            const data = kegiatanData[selectedId];
            let header1 = '<tr><th rowspan="2" class="px-4 py-3 text-center align-middle bg-slate-100">Nama Murid</th>';
            let header2 = '<tr>';

            Object.values(data.dims).forEach(dim => {
                let dimColspan = dim.subdims.length;
                if (dimColspan > 0) {
                    header1 += `<th colspan="${dimColspan}" class="px-4 py-3 text-center border-b border-l">${dim.name}</th>`;
                    
                    dim.subdims.forEach((subdim, subdimIndex) => {
                         const detail = subdimensiDetail[dim.name]?.find(s => s.name === subdim.name) || {};
                         let kriteriaText = Object.entries({ Mahir: detail.mahir, Cakap: detail.cakap, Berkembang: detail.berk })
                            .map(([key, value]) => `<tr><td style='vertical-align:top; font-weight:600; padding-right:8px; white-space:nowrap;'>${key}:</td><td style='vertical-align:top; text-align:justify;'>${value || '-'}</td></tr>`).join('');
                         const tooltipHTML = `<div class='tooltip-container'><span class='underline decoration-dotted cursor-help'>${subdim.name}</span><span class='tooltip' role='tooltip'><table style="width: 100%;">${kriteriaText}</table></span></div>`;
                         header2 += `<th class="px-2 py-2 text-center font-normal text-xs border-l whitespace-normal max-w-[120px]">${tooltipHTML}</th>`;
                    });
                }
            });
            header1 += '</tr>'; header2 += '</tr>';

            container.innerHTML = `<table class="asesmen-table-sticky min-w-full text-sm"><thead class="bg-slate-50">${header1}${header2}</thead><tbody id="asesmen-tbody" class="bg-white"></tbody></table>`;
            
            const tbody = document.getElementById('asesmen-tbody');
            daftarMurid.forEach(nama => tambahBarisMuridAsesmen(tbody, nama));
        };

        const resetAsesmenTab = () => {
            const selectedId = document.getElementById('asesmen-kegiatan-select')?.value;
            if (!selectedId) {
                showNotification('Silakan pilih kegiatan dari daftar untuk mereset data asesmennya.');
                return;
            }
            const message = `Apakah Anda yakin ingin menghapus semua data isian asesmen untuk kegiatan "${kegiatanData[selectedId]?.name}"? Tindakan ini tidak dapat diurungkan.`;
            showConfirmation(message, () => {
                daftarMurid.forEach(nama => {
                    if (muridData[nama] && muridData[nama][selectedId]) {
                        delete muridData[nama][selectedId];
                    }
                });
                renderAsesmenTable(); 
                saveState(); 
                showNotification('Data isian untuk kegiatan ini telah direset.');
            });
        };
        
        // --- Murid Tab Functions (No major change, keeping for context) ---
        
        const updateUndoRedoButtons = () => {
            const undoBtn = document.getElementById('undo-murid-btn');
            const redoBtn = document.getElementById('redo-murid-btn');
            if(undoBtn) undoBtn.disabled = muridHistoryIndex <= 0;
            if(redoBtn) redoBtn.disabled = muridHistoryIndex >= muridHistory.length - 1;
        };

        const saveMuridStateToHistory = (newState) => {
            muridHistory = muridHistory.slice(0, muridHistoryIndex + 1);
            muridHistory.push(newState);
            muridHistoryIndex = muridHistory.length - 1;
            daftarMurid = [...newState];
            updateUndoRedoButtons();
            saveState();
        };

        const renderMuridTable = () => {
            const tbody = document.getElementById('murid-table-body');
            if(!tbody) return;
            tbody.innerHTML = '';
            
            const currentList = muridHistory[muridHistoryIndex];
            daftarMurid = [...currentList];

            if (currentList.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="3" class="text-center text-slate-500 py-6">Belum ada data murid. Klik "Tambah Murid" untuk memulai.</td></tr>`;
            } else {
                 currentList.forEach((nama, index) => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b';
                    tr.dataset.index = index;
                    tr.innerHTML = `
                        <td class="px-4 py-2 text-center text-slate-500">${index + 1}</td>
                        <td class="px-4 py-2 text-center w-28">
                            <div class="flex justify-center gap-1">
                                <div class="tooltip-container">
                                    <button class="edit-murid-btn text-blue-600 hover:text-blue-800 p-1" aria-label="Ubah nama ${nama}"><i class="fas fa-pencil-alt"></i></button>
                                    <span class="tooltip" role="tooltip">Ubah nama murid</span>
                                </div>
                                <div class="tooltip-container">
                                    <button class="delete-murid-btn text-red-600 hover:text-red-800 p-1" aria-label="Hapus ${nama}"><i class="fas fa-trash-alt"></i></button>
                                    <span class="tooltip" role="tooltip">Hapus murid</span>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-2 text-slate-800">${nama}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            updateUndoRedoButtons();
            saveState(); 
        };

        const renderMuridPage = () => {
            const page = DOMElements.tabContents.murid;
            page.innerHTML = `<div class="max-w-4xl mx-auto">
                <div class="flex flex-wrap gap-4 justify-between items-center mb-4 pb-4 border-b">
                     <div class="flex items-center gap-2">
                         <div class="tooltip-container">
                            <button id="tambah-murid-btn" class="inline-flex items-center px-4 py-2 bg-sky-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-sky-700"><i class="fas fa-plus mr-2"></i>Tambah Murid</button>
                            <span class="tooltip tooltip-left" role="tooltip">Tambah baris baru untuk nama murid</span>
                        </div>
                        <div class="tooltip-container">
                            <button id="undo-murid-btn" class="murid-table-btn text-slate-600" aria-label="Undo"><i class="fas fa-undo-alt"></i></button>
                            <span class="tooltip" role="tooltip">Batalkan aksi terakhir (Undo)</span>
                        </div>
                        <div class="tooltip-container">
                            <button id="redo-murid-btn" class="murid-table-btn text-slate-600" aria-label="Redo"><i class="fas fa-redo-alt"></i></button>
                            <span class="tooltip" role="tooltip">Ulangi aksi yang dibatalkan (Redo)</span>
                        </div>
                     </div>
                     <div class="flex items-center gap-2">
                        <div class="tooltip-container">
                            <button id="template-nama-btn" class="inline-flex items-center justify-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-blue-700"><i class="fas fa-file-excel mr-2"></i>Template</button>
                            <span class="tooltip" role="tooltip">Unduh templat Excel untuk mengisi daftar nama murid</span>
                        </div>
                        <div class="tooltip-container">
                            <button id="ekspor-nama-btn" class="inline-flex items-center justify-center px-4 py-2 bg-teal-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-teal-700"><i class="fas fa-file-export mr-2"></i>Ekspor</button>
                            <span class="tooltip" role="tooltip">Ekspor daftar nama murid saat ini ke file Excel</span>
                        </div>
                        <div class="tooltip-container">
                            <button id="impor-nama-btn" class="inline-flex items-center justify-center px-4 py-2 bg-slate-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-slate-700"><i class="fas fa-file-import mr-2"></i>Impor</button>
                            <span class="tooltip" role="tooltip">Impor daftar nama murid dari file Excel</span>
                        </div>
                         <input type="file" id="import-nama-file-input" class="hidden" accept=".xlsx, .xls">
                        <div class="tooltip-container">
                            <button id="reset-murid-btn" class="inline-flex items-center justify-center px-4 py-2 bg-amber-500 text-white text-sm font-medium rounded-md shadow-sm hover:bg-amber-600"><i class="fas fa-undo mr-2"></i>Reset</button>
                            <span class="tooltip" role="tooltip">Hapus semua nama murid dari daftar</span>
                        </div>
                    </div>
                </div>

                <div class="overflow-auto bg-white rounded-lg shadow" style="max-height: 60vh;">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-slate-700 uppercase bg-slate-100 sticky top-0">
                            <tr>
                                <th class="px-4 py-3 w-16 text-center">No</th>
                                <th class="px-4 py-3 text-center">Aksi</th>
                                <th class="px-4 py-3 text-center">Nama Murid</th>
                            </tr>
                        </thead>
                        <tbody id="murid-table-body"></tbody>
                    </table>
                </div>
            </div>`;

            renderMuridTable();

            page.querySelector('#tambah-murid-btn').addEventListener('click', () => {
                const newList = [...muridHistory[muridHistoryIndex], ""];
                saveMuridStateToHistory(newList);
                renderMuridTable();
                const lastRow = document.querySelector('#murid-table-body tr:last-child');
                if(lastRow) lastRow.querySelector('.edit-murid-btn').click();
            });

            page.querySelector('#undo-murid-btn').addEventListener('click', () => {
                if(muridHistoryIndex > 0) {
                    muridHistoryIndex--;
                    renderMuridTable();
                }
            });
            
            page.querySelector('#redo-murid-btn').addEventListener('click', () => {
                 if(muridHistoryIndex < muridHistory.length - 1) {
                    muridHistoryIndex++;
                    renderMuridTable();
                }
            });

            page.querySelector('#reset-murid-btn').addEventListener('click', () => {
                showConfirmation("Yakin ingin menghapus semua nama murid dan data asesmen terkait? Aksi ini tidak dapat diurungkan.", () => {
                    muridData = {}; // Hapus juga semua data asesmen
                    saveMuridStateToHistory([]);
                    renderMuridTable();
                    showNotification("Daftar murid dan semua data asesmen telah direset.");
                });
            });

            page.querySelector('#template-nama-btn').addEventListener('click', () => handleDownloadAsesmenTemplate('nama', 'template'));
            page.querySelector('#ekspor-nama-btn').addEventListener('click', () => handleDownloadAsesmenTemplate('nama', 'export'));
            
            const importNamaBtn = page.querySelector('#impor-nama-btn');
            const importNamaFileInput = page.querySelector('#import-nama-file-input');
            importNamaBtn.addEventListener('click', () => importNamaFileInput.click());
            importNamaFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const workbook = XLSX.read(e.target.result, { type: 'array' });
                        const ws = workbook.Sheets[workbook.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(ws, { header: 1 });
                        const currentNames = new Set(muridHistory[muridHistoryIndex]);
                        let addedCount = 0;
                        json.slice(1).forEach(row => {
                           if(row[0]) {
                               const name = String(row[0]).trim();
                               if(name && !currentNames.has(name)) {
                                   currentNames.add(name);
                                   addedCount++;
                               }
                           }
                        });
                        const newList = Array.from(currentNames).sort((a,b)=>a.localeCompare(b));
                        saveMuridStateToHistory(newList);
                        renderMuridTable();
                        showNotification(`${addedCount} nama baru berhasil diimpor.`);
                    } catch(err) {
                         showNotification('Gagal mengimpor file. Pastikan file Excel Anda hanya berisi satu kolom dengan judul "Nama Murid" di baris pertama.');
                    }
                };
                reader.readAsArrayBuffer(file);
                event.target.value = null;
            });
            
            // Event delegation for table actions
            const tbody = page.querySelector('#murid-table-body');
            tbody.addEventListener('click', e => {
                const editBtn = e.target.closest('.edit-murid-btn');
                const deleteBtn = e.target.closest('.delete-murid-btn');
                const saveBtn = e.target.closest('.save-murid-btn');
                const cancelBtn = e.target.closest('.cancel-murid-btn');
                
                if (editBtn) {
                    const tr = editBtn.closest('tr');
                    const index = parseInt(tr.dataset.index, 10);
                    const currentName = muridHistory[muridHistoryIndex][index];

                    const namaCell = tr.cells[2];
                    namaCell.innerHTML = `<input type="text" class="w-full p-1 border rounded" value="${currentName}">`;
                    
                    const aksiCell = tr.cells[1];
                    aksiCell.innerHTML = `<div class="flex justify-center gap-1">
                        <div class="tooltip-container">
                            <button class="save-murid-btn text-green-600 hover:text-green-800 p-1" aria-label="Simpan perubahan nama"><i class="fas fa-check"></i></button>
                            <span class="tooltip" role="tooltip">Simpan perubahan</span>
                        </div>
                        <div class="tooltip-container">
                            <button class="cancel-murid-btn text-slate-600 hover:text-slate-800 p-1" aria-label="Batal mengubah nama"><i class="fas fa-times"></i></button>
                            <span class="tooltip" role="tooltip">Batal mengubah</span>
                        </div>
                    </div>`;
                    namaCell.querySelector('input').focus();
                }

                if(deleteBtn) {
                    const tr = deleteBtn.closest('tr');
                    const index = parseInt(tr.dataset.index, 10);
                    const nameToDelete = muridHistory[muridHistoryIndex][index];
                     showConfirmation(`Yakin ingin menghapus "${nameToDelete}" dan semua data asesmennya?`, () => {
                        // Hapus data asesmen murid yang bersangkutan
                        if (muridData[nameToDelete]) {
                            delete muridData[nameToDelete];
                        }
                        const newList = [...muridHistory[muridHistoryIndex]];
                        newList.splice(index, 1);
                        saveMuridStateToHistory(newList);
                        renderMuridTable();
                     });
                }

                if(saveBtn) {
                    const tr = saveBtn.closest('tr');
                    const index = parseInt(tr.dataset.index, 10);
                    const input = tr.querySelector('input');
                    const newName = input.value.trim();
                    const oldName = muridHistory[muridHistoryIndex][index];

                    if(newName && newName !== oldName) {
                        // Bug Fix: Pindahkan data asesmen dari nama lama ke nama baru
                        if (muridData[oldName]) {
                            muridData[newName] = muridData[oldName];
                            delete muridData[oldName];
                        }

                        const newList = [...muridHistory[muridHistoryIndex]];
                        newList[index] = newName;
                        saveMuridStateToHistory(newList.sort((a,b)=>a.localeCompare(b)));
                        renderMuridTable();
                    } else if (!newName) {
                        showNotification("Nama murid tidak boleh kosong.");
                    } else {
                        // Jika nama tidak berubah, cukup render ulang tabel untuk keluar dari mode edit
                        renderMuridTable();
                    }
                }
                
                if(cancelBtn) {
                    renderMuridTable(); // Just re-render to cancel edit
                }
            });
        };

        const updateUndoRedoButtonsIdentitas = () => {
            const undoBtn = document.getElementById('undo-identitas-btn');
            const redoBtn = document.getElementById('redo-identitas-btn');
            if(undoBtn) undoBtn.disabled = identitasHistoryIndex <= 0;
            if(redoBtn) redoBtn.disabled = identitasHistoryIndex >= identitasHistory.length - 1;
        };

        const saveIdentitasStateToHistory = (newData) => {
            if (JSON.stringify(newData) === JSON.stringify(identitasHistory[identitasHistoryIndex])) {
                return;
            }
            identitasHistory = identitasHistory.slice(0, identitasHistoryIndex + 1);
            identitasHistory.push(JSON.parse(JSON.stringify(newData))); // deep copy
            identitasHistoryIndex = identitasHistory.length - 1;
            identitasData = newData; 
            updateUndoRedoButtonsIdentitas();
            saveState();
        };

        const updateUndoRedoButtonsPerancangan = () => {
            const undoBtn = document.getElementById('undo-perancangan-btn');
            const redoBtn = document.getElementById('redo-perancangan-btn');
            if(undoBtn) undoBtn.disabled = perancanganHistoryIndex <= 0;
            if(redoBtn) redoBtn.disabled = perancanganHistoryIndex >= perancanganHistory.length - 1;
        };

        const captureAndSavePerancanganState = () => {
            simpanPerancangan(); // Updates global kegiatanData from DOM
            const currentData = JSON.parse(JSON.stringify(kegiatanData)); 

            if (JSON.stringify(currentData) === JSON.stringify(perancanganHistory[perancanganHistoryIndex])) {
                return; 
            }

            perancanganHistory = perancanganHistory.slice(0, perancanganHistoryIndex + 1);
            perancanganHistory.push(currentData);
            perancanganHistoryIndex = perancanganHistory.length - 1;

            updateUndoRedoButtonsPerancangan();
            saveState();
        };


        const renderAsesmenPage = () => {
            const page = DOMElements.tabContents.asesmen;
            page.innerHTML = `<div class="asesmen-toolbar flex flex-wrap gap-4 justify-between items-center mb-6"> <div class="flex items-center gap-2 flex-grow"><label for="asesmen-kegiatan-select" class="text-sm font-medium sr-only md:not-sr-only">Pilih Kegiatan:</label> <select id="asesmen-kegiatan-select" class="p-2 border border-slate-300 rounded-md shadow-sm w-full md:w-auto"></select></div> <div class="flex items-center gap-2 flex-shrink-0">
                <div class="tooltip-container">
                    <button id="template-asesmen-btn" class="inline-flex items-center justify-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-blue-700"><i class="fas fa-file-excel mr-2"></i>Template</button>
                    <span class="tooltip" role="tooltip">Unduh templat Excel untuk semua kegiatan</span>
                </div>
                <div class="tooltip-container">
                    <button id="ekspor-asesmen-btn" class="inline-flex items-center justify-center px-4 py-2 bg-teal-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-teal-700"><i class="fas fa-file-export mr-2"></i>Ekspor</button>
                    <span class="tooltip" role="tooltip">Ekspor semua nilai asesmen yang telah diisi</span>
                </div>
                <div class="tooltip-container">
                    <button id="impor-asesmen-btn" class="inline-flex items-center justify-center px-4 py-2 bg-slate-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-slate-700"><i class="fas fa-file-import mr-2"></i>Impor</button>
                    <span class="tooltip" role="tooltip">Impor nilai asesmen dari file Excel</span>
                </div>
                <input type="file" id="import-asesmen-file-input" class="hidden" accept=".xlsx, .xls">
                <div class="tooltip-container">
                    <button id="reset-asesmen-btn" class="inline-flex items-center justify-center px-4 py-2 bg-amber-500 text-white text-sm font-medium rounded-md shadow-sm hover:bg-amber-600"><i class="fas fa-undo mr-2"></i>Reset</button>
                    <span class="tooltip" role="tooltip">Hapus semua isian nilai untuk kegiatan ini</span>
                </div>
                <div class="tooltip-container">
                    <button id="buat-laporan-btn" class="inline-flex items-center justify-center px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-green-700"><i class="fas fa-wand-magic-sparkles mr-2"></i>Sintesis & Lihat Hasil</button>
                    <span class="tooltip" role="tooltip">Proses nilai dan lihat hasilnya di tab berikutnya</span>
                </div>
            </div> </div> <div id="asesmen-table-container" class="overflow-auto mt-6 border rounded-lg" style="max-height: 60vh;"></div>`;
            const select = page.querySelector('#asesmen-kegiatan-select');
            
            Object.entries(kegiatanData).forEach(([id, data]) => {
                if (data.dims && Object.keys(data.dims).length > 0) select.innerHTML += `<option value="${id}">${data.name}</option>`;
            });

            currentAsesmenViewId = select.value;
            select.addEventListener('change', () => {
                simpanAsesmen(currentAsesmenViewId);
                currentAsesmenViewId = select.value;
                renderAsesmenTable();
            });
            
            page.querySelector('#buat-laporan-btn').addEventListener('click', () => showTab('hasil'));
            page.querySelector('#reset-asesmen-btn').addEventListener('click', resetAsesmenTab);
            page.querySelector('#template-asesmen-btn').addEventListener('click', () => handleDownloadAsesmenTemplate('semua'));
            page.querySelector('#ekspor-asesmen-btn').addEventListener('click', handleExportAsesmen);
            
            const importAsesmenBtn = page.querySelector('#impor-asesmen-btn');
            const importAsesmenFileInput = page.querySelector('#import-asesmen-file-input');
            importAsesmenBtn.addEventListener('click', () => importAsesmenFileInput.click());
            importAsesmenFileInput.addEventListener('change', handleImportAsesmen);

            renderAsesmenTable();
        };

        // MODIFIED function for rendering API Key input
        const renderApiKeyInput = (page) => {
            // Inject API Key input area before the table
            const apiKeyHTML = `
                <div class="api-key-container p-4 rounded-lg mb-6 border border-amber-300 bg-amber-50">
                    <h3 class="text-lg font-semibold text-amber-800 flex items-center mb-3">
                        <i class="fas fa-key mr-2 text-amber-600"></i>Pengaturan Kunci API Gemini
                    </h3>
                    <p class="text-sm text-amber-700 mb-4">Untuk menggunakan fitur <strong>Generate AI Narasi</strong>, Anda perlu memasukkan Kunci API Google Gemini Anda. Dapatkan kunci gratis di <a href="https://aistudio.google.com/app/apikey" target="_blank" class="font-medium underline text-amber-800 hover:text-amber-900">Google AI Studio</a>.</p>
                    <div class="flex items-center gap-3">
                        <input id="geminiApiKeyInput" name="geminiApiKey" type="password" value="${identitasData.geminiApiKey || ''}" placeholder="Masukkan Kunci API Anda di sini" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-amber-500"/>
                        <button id="save-api-key-btn" class="inline-flex items-center justify-center px-4 py-2 bg-amber-700 text-white text-sm font-medium rounded-md shadow-sm hover:bg-amber-800 flex-shrink-0" title="Simpan API Key">Simpan</button>
                    </div>
                </div>`;
            
            page.insertAdjacentHTML('afterbegin', apiKeyHTML);

            const input = document.getElementById('geminiApiKeyInput');
            const saveBtn = document.getElementById('save-api-key-btn');

            saveBtn.addEventListener('click', () => {
                identitasData.geminiApiKey = input.value.trim();
                saveIdentitasStateToHistory(identitasData);
                showNotification('Kunci API berhasil disimpan.');
            });

            input.addEventListener('input', () => {
                // Automatically save on input change without notification
                identitasData.geminiApiKey = input.value.trim();
                saveIdentitasStateToHistory(identitasData);
            });
        };

        // NEW function to extract data for AI prompt
        const prepareAIPromptData = (nama) => {
            // Periksa apakah nama murid ada
            if (!nama || !muridData[nama]) return null;

            const activities = [];
            let hasValidScore = false;
            
            Object.entries(muridData[nama]).forEach(([kegiatanId, asesmenKegiatan]) => {
                const kegiatanInfo = kegiatanData[kegiatanId];
                if (!kegiatanInfo || Object.keys(asesmenKegiatan).length === 0) return;
                
                const dimensions = [];
                
                Object.entries(asesmenKegiatan).forEach(([dimId, subdimScoreList]) => {
                    const dimInfo = kegiatanInfo.dims[dimId]; 
                    if (!dimInfo || !Array.isArray(subdimScoreList)) return;

                    const subdimensions = [];
                    
                    dimInfo.subdims.forEach((subdim, subdimIndex) => {
                        const capaianKey = subdimScoreList[subdimIndex];
                        if (capaianKey) {
                            hasValidScore = true; // Set flag jika ada skor valid
                            const detail = subdimensiDetail[dimInfo.name]?.find(s => s.name === subdim.name);
                            if (detail) {
                                subdimensions.push({
                                    nama: subdim.name,
                                    capaian: capaianOptions[capaianKey],
                                    keterangan: detail[capaianKey.toLowerCase()]
                                });
                            }
                        }
                    });

                    if (subdimensions.length > 0) {
                        dimensions.push({
                            nama: dimInfo.name,
                            subdimensi: subdimensions
                        });
                    }
                });

                if (dimensions.length > 0) {
                    activities.push({
                        namaKegiatan: kegiatanInfo.name,
                        dimensi: dimensions
                    });
                }
            });

            if (activities.length === 0 || !hasValidScore) return null;

            return {
                namaMurid: nama,
                dataKegiatan: activities
            };
        };

        // NEW function to handle AI generation for a single row
        const generateAINarrative = async (row) => {
            const nama = row.dataset.namaMurid;
            const p = row.querySelector('.narasi-p');
            const btn = row.querySelector('.generate-ai-btn') || document.getElementById('generate-ai-all-btn');
            
            // Pengecekan nama murid
            if (!nama) {
                showNotification("Kesalahan: Nama murid tidak teridentifikasi pada baris ini.");
                return;
            }

            const promptData = prepareAIPromptData(nama);
            
            if (!promptData) {
                // Tidak menampilkan notifikasi jika ini dipanggil dari 'Generate AI All'
                if(btn.id !== 'generate-ai-all-btn') {
                     showNotification(`Tidak ada data asesmen yang valid untuk ${nama}. Harap lengkapi asesmen terlebih dahulu.`);
                }
                return;
            }
            
            if (!identitasData.geminiApiKey) {
                if(btn.id !== 'generate-ai-all-btn') {
                     showNotification("Kunci API Gemini belum dimasukkan. Silakan masukkan di bagian 'Pengaturan Kunci API Gemini'.");
                }
                return;
            }

            // Disable button and show loading spinner
            const originalIcon = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            // Construct the detailed prompt
            let detailedData = `Nama Murid: ${promptData.namaMurid}\n\n`;
            promptData.dataKegiatan.forEach(activity => {
                detailedData += `Kegiatan: ${activity.namaKegiatan}\n`;
                activity.dimensi.forEach(dim => {
                    detailedData += `  Dimensi: ${dim.nama}\n`;
                    dim.subdimensi.forEach(sub => {
                        detailedData += `    - Subdimensi: ${sub.nama} (Tingkat: ${sub.capaian})\n`;
                    });
                });
            });
            
            // MODIFIKASI PROMPT UNTUK HASIL YANG LEBIH NATURAL DAN KOMPREHENSIF
            const prompt = `Buatkan narasi rapor kegiatan kokurikuler untuk murid ini berdasarkan data capaian di bawah. 
Terapkan aturan penulisan berikut: 
1. Selalu mulai narasi dengan 'Ananda ${promptData.namaMurid}' diikuti dengan ringkasan keterlibatan dalam kegiatan. 
2. Kemudian, sintesiskan pencapaian terbaik (Mahir/Cakap) dari berbagai Subdimensi ke dalam narasi yang mengalir, fokus pada Dimensi Profil Lulusan yang paling menonjol.
3. Gunakan frasa transisi yang halus menuju area yang perlu ditingkatkan (Berkembang).
4. Akhiri dengan kalimat motivasi yang ringkas, positif, dan spesifik tentang langkah selanjutnya.
5. Gunakan bahasa Indonesia baku yang berwibawa, inspiratif, kohesif, dan enak dibaca.
6. Pastikan narasi HANYA terdiri dari satu paragraf komprehensif (maksimal 500 karakter).
7. Format output HANYA JSON.

Data Murid:\n${detailedData}`;

            try {
                const aiNarasi = await callGeminiAPI(prompt);
                
                if (aiNarasi) {
                    // Simpan narasi AI sebagai variasi terakhir
                    let narratives;
                    try {
                        // Coba parse narratives yang sudah ada
                        narratives = JSON.parse(row.dataset.narratives);
                    } catch (e) {
                        // Jika gagal, inisialisasi dengan narasi default yang kosong/minimal
                        narratives = [{html: p.innerHTML, clean: p.innerText}];
                    }

                    // Pastikan setidaknya ada 5 narasi variasi, hanya ambil 5 narasi pertama
                    const defaultCount = 5;
                    // Filter out previous AI gen before slicing default variants
                    const defaultNarratives = narratives.filter(n => !n.aiGenerated).slice(0, defaultCount); 
                    
                    // Tambahkan narasi AI baru
                    const newAINarrative = {
                        html: aiNarasi.replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold text-slate-900">$1</strong>').replace(/\*(.*?)\*/g, '<em class="italic text-slate-600">$1</em>').replace(/\n/g, '<br>'),
                        clean: aiNarasi.replace(/[*_]/g, '').replace(/\n/g, ' '),
                        aiGenerated: true
                    };
                    
                    // Add AI narrative at the end (index defaultCount)
                    const finalNarrativeObjects = [...defaultNarratives, newAINarrative];
                    const aiIndex = finalNarrativeObjects.length - 1;
                    
                    // Perbarui state row
                    row.dataset.narratives = JSON.stringify(finalNarrativeObjects);
                    row.dataset.narrativeIndex = aiIndex.toString(); // Tampilkan hasil AI terbaru
                    p.innerHTML = finalNarrativeObjects[aiIndex].html;
                    
                    // Notifikasi per siswa Dihilangkan sesuai permintaan sebelumnya
                } else {
                    throw new Error("Respon AI tidak mengandung narasi yang valid.");
                }
            } catch (error) {
                console.error("AI Generation failed:", error);
                throw error; // Lempar error untuk ditangkap di generate-ai-all-btn listener
            } finally {
                // Re-enable button
                if(btn.id !== 'generate-ai-all-btn') {
                    btn.disabled = false;
                    btn.innerHTML = originalIcon;
                }
                saveState();
            }
        };


        // Modified renderHasilPage
        const renderHasilPage = () => {
            simpanAsesmen(currentAsesmenViewId); // Ensure latest scores are saved
            let sortOrder = 'asc';
            const page = DOMElements.tabContents.hasil;
            
            // MODIFIKASI IKON generate AI sesuai permintaan #1
            page.innerHTML = `<div id="api-key-placeholder"></div>
            <div class="flex flex-wrap justify-between items-center mb-4 gap-4"> 
                <h2 class="text-2xl font-bold text-slate-800">Hasil Sintesis Laporan</h2>
                <div class="flex items-center gap-2">
                    <div class="tooltip-container">
                        <button id="resintesis-btn" class="inline-flex items-center px-4 py-2 bg-sky-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-sky-700"><i class="fas fa-sync-alt mr-2"></i>Resintesis Semua</button>
                        <span class="tooltip" role="tooltip">Buat ulang semua narasi dengan variasi kalimat berbeda</span>
                    </div>
                    <!-- IKON DIUBAH DARI fas fa-robot MENJADI fas fa-brain -->
                    <div class="tooltip-container">
                         <button id="generate-ai-all-btn" class="inline-flex items-center px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-purple-700"><i class="fas fa-brain mr-2"></i>Generate AI</button>
                         <span class="tooltip" role="tooltip">Gunakan AI (Kecerdasan Buatan) untuk membuat narasi untuk semua murid.</span>
                    </div>
                    <div class="tooltip-container">
                        <button id="ekspor-hasil-btn" class="inline-flex items-center justify-center px-4 py-2 bg-teal-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-teal-700"><i class="fas fa-file-export mr-2"></i>Ekspor</button>
                        <span class="tooltip" role="tooltip">Ekspor ke Excel atau PDF</span>
                    </div>
                </div> 
            </div>
            <div class="overflow-auto bg-white rounded-lg shadow" style="max-height: 70vh;">
                <table id="hasil-table" class="w-full text-sm text-left text-slate-500">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                        <tr>
                            <th scope="col" class="sticky top-0 px-6 py-3 w-12 text-center bg-slate-100 z-10">No</th>
                            <th scope="col" id="sort-nama-header" class="sticky top-0 px-6 py-3 text-center bg-slate-100 z-10 cursor-pointer hover:bg-slate-200">Nama Murid <i id="sort-icon" class="fas fa-sort ml-1"></i></th>
                            <th scope="col" class="sticky top-0 px-6 py-3 text-center bg-slate-100 z-10">Capaian Kompetensi</th>
                            <th scope="col" class="sticky top-0 px-6 py-3 text-center w-48 bg-slate-100 z-10">Aksi</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>`;
            
            renderApiKeyInput(page.querySelector('#api-key-placeholder')); // Render API Key input
            
            const tbody = page.querySelector('#hasil-table tbody');
            const sortHeader = page.querySelector('#sort-nama-header');
            const sortIcon = page.querySelector('#sort-icon');

            const renderTableBody = () => {
                tbody.innerHTML = ''; 

                let validMurid = daftarMurid.filter(nama => muridData[nama] && Object.values(muridData[nama]).some(keg => Object.keys(keg).length > 0));

                if (sortOrder === 'asc') {
                    validMurid.sort((a, b) => a.localeCompare(b));
                    sortIcon.className = 'fas fa-sort-up ml-1';
                } else {
                    validMurid.sort((a, b) => b.localeCompare(a));
                    sortIcon.className = 'fas fa-sort-down ml-1';
                }
                
                if (validMurid.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" class="text-center py-10 px-6 bg-slate-50"><i class="fas fa-file-alt text-4xl text-slate-400"></i><p class="mt-4 text-slate-500">Belum ada data asesmen yang diisi untuk murid yang terdaftar.</p></td></tr>`;
                    return;
                }
            
                validMurid.forEach((nama, muridIndex) => {
                    const allSubdimensiData = []; 
                    const kegiatanDiikuti = new Set();
                    
                    if(muridData[nama]) {
                        Object.entries(muridData[nama]).forEach(([kegiatanId, asesmenKegiatan]) => {
                            const kegiatanInfo = kegiatanData[kegiatanId];
                            if (!kegiatanInfo || Object.keys(asesmenKegiatan).length === 0) return;
                            kegiatanDiikuti.add(kegiatanInfo.name);
                            
                            Object.entries(asesmenKegiatan).forEach(([dimId, subdimScoreList]) => {
                                const dimInfo = kegiatanInfo.dims[dimId]; 
                                if (!dimInfo || !Array.isArray(subdimScoreList)) return;
                                
                                dimInfo.subdims.forEach((subdim, subdimIndex) => {
                                    const capaianKey = subdimScoreList[subdimIndex];
                                    if (capaianKey && capaianToNumber[capaianKey]) {
                                        const detail = subdimensiDetail[dimInfo.name]?.find(s => s.name === subdim.name);
                                        if (detail) {
                                            allSubdimensiData.push({
                                                dimName: dimInfo.name,
                                                subdimName: subdim.name,
                                                score: capaianToNumber[capaianKey], // 1, 2, or 3
                                                capaianKey: capaianKey, // B, C, or M
                                                detail: detail
                                            });
                                        }
                                    }
                                });
                            });
                        });
                    }
                
                    const avgScores = dimensiProfil.map(dimName => {
                        const dimSubdims = allSubdimensiData.filter(d => d.dimName === dimName);
                        if (dimSubdims.length === 0) return null;
                        const totalScore = dimSubdims.reduce((sum, d) => sum + d.score, 0);
                        const avg = totalScore / dimSubdims.length;
                        
                        return { 
                            name: dimName, 
                            avg: avg, 
                            subdims: dimSubdims,
                            // Determine the overall level of the dimension based on average score:
                            level: avg >= 2.5 ? 'Mahir' : (avg >= 1.5 ? 'Cakap' : 'Berkembang')
                        };
                    }).filter(Boolean);

                    // Group dimensions by level
                    const mahirSubdims = allSubdimensiData.filter(d => d.capaianKey === 'M');
                    const cakapSubdims = allSubdimensiData.filter(d => d.capaianKey === 'C');
                    const berkembangSubdims = allSubdimensiData.filter(d => d.capaianKey === 'B');

                    const formatKegiatan = (set) => { 
                        const arr = Array.from(set);
                        if (arr.length === 0) return 'kegiatan kokurikuler';
                        if (arr.length === 1) return `kegiatan **${arr[0]}**`;
                        if (arr.length === 2) return `kegiatan **${arr[0]}** dan **${arr[1]}**`;
                        return `kegiatan ${arr.slice(0, -1).map(k => `**${k}**`).join(', ')}, dan **${arr[arr.length-1]}**`; 
                    };
                    
                    const daftarKegiatanStr = formatKegiatan(kegiatanDiikuti);
                    
                    let narratives = [];
                    
                    // Function to simplify the phrase from the detailed description
                    const getSimplifiedPhrase = (text) => {
                        if (!text) return 'menunjukkan kemampuan yang baik';
                        const parts = text.split(/[.,;]/);
                        let phrase = parts[0].trim();
                        if (phrase.toLowerCase().startsWith('mampu') || phrase.toLowerCase().startsWith('melaksanakan') || phrase.toLowerCase().startsWith('menunjukkan')) {
                            // If it starts with an active verb, keep it direct
                            return phrase.charAt(0).toLowerCase() + phrase.slice(1);
                        }
                        // Otherwise, simplify/summarize (fallback)
                        return phrase.charAt(0).toLowerCase() + phrase.slice(1);
                    };
                    
                    // Helper to join multiple phrases/names smoothly
                    const joinPhrases = (phrases) => {
                        if (phrases.length === 0) return '';
                        if (phrases.length === 1) return phrases[0];
                        if (phrases.length === 2) return `${phrases[0]} dan ${phrases[1]}`;
                        return `${phrases.slice(0, -1).join(', ')}, dan ${phrases[phrases.length - 1]}`;
                    };

                    // REVISED CORE NARRATIVE (NO BULLETS, ONE PARAGRAPH STYLE)
                    const getCoreNarrative = (mahir, cakap, berkembang, variantIndex) => {
                        let achievements = [];
                        let focusAreas = [];
                        
                        // Mahir Achievements
                        // Perbaikan: Hanya mengambil kata kunci kemampuan, menghilangkan subdimensi
                        mahir.forEach(d => {
                            const levelDesc = d.detail.mahir;
                            const simplePhrase = getSimplifiedPhrase(levelDesc);
                            // Mengganti "mampu *phrase* dalam dimensi **Dimensi**" menjadi lebih kohesif
                            achievements.push(`telah menguasai kemampuan *${simplePhrase}* pada dimensi **${d.dimName}**`);
                        });
                        
                        // Cakap Achievements
                        // Perbaikan: Hanya mengambil kata kunci kemampuan, menghilangkan subdimensi
                        cakap.forEach(d => {
                            const levelDesc = d.detail.cakap;
                            const simplePhrase = getSimplifiedPhrase(levelDesc);
                            // Mengganti "sudah *phrase* dalam dimensi **Dimensi**" menjadi lebih kohesif
                            achievements.push(`menunjukkan kemajuan dalam *${simplePhrase}* pada dimensi **${d.dimName}**`);
                        });
                        
                        // Focus Areas (Berkembang)
                        // Perbaikan: Menghilangkan subdimensi dari narasi area fokus. Fokus pada tujuan cakap/mahir
                        berkembang.forEach(d => {
                            const goalDesc = d.detail.cakap || d.detail.mahir;
                            const dimName = d.dimName;
                            // Fokus pada Dimensi dan tujuan capaian (Mahir/Cakap)
                            focusAreas.push(`dimensi **${dimName}** agar dapat *${getSimplifiedPhrase(goalDesc)}*`);
                        });

                        let narasiInti = '';
                        
                        if (achievements.length > 0) {
                            // Mencari dimensi unik untuk menghindari pengulangan nama dimensi yang terlalu sering
                            const uniqueDimAchievements = {};
                            [...mahir, ...cakap].forEach(d => {
                                // Menggunakan achievements yang sudah disempurnakan di atas
                                const phrase = d.capaianKey === 'M' 
                                    ? `telah menguasai kemampuan *${getSimplifiedPhrase(d.detail.mahir)}*`
                                    : `menunjukkan kemajuan dalam *${getSimplifiedPhrase(d.detail.cakap)}*`;

                                if (!uniqueDimAchievements[d.dimName]) {
                                    uniqueDimAchievements[d.dimName] = new Set();
                                }
                                uniqueDimAchievements[d.dimName].add(phrase);
                            });
                            
                            const dimSummary = Object.entries(uniqueDimAchievements).map(([dimName, phrases]) => {
                                return `dimensi **${dimName}** dengan capaian seperti ${joinPhrases(Array.from(phrases))}`;
                            });
                            
                            // Variant 1 (even index): General summary focusing on progress
                            if (variantIndex % 2 === 0) {
                                narasiInti += `Ananda menunjukkan perkembangan yang sangat baik, terlihat dari penguasaannya pada ${joinPhrases(dimSummary)}. `;
                            } else {
                                // Variant 2 (odd index): More direct, action-oriented summary
                                narasiInti += `Ananda berhasil menonjolkan kompetensi inti, dengan kemampuan yang kuat dalam ${joinPhrases(dimSummary)}. `;
                            }
                        }
                        
                        if (focusAreas.length > 0) {
                            // Menghilangkan redundansi pada frasa "Namun, terdapat area yang memerlukan fokus pengembangan, khususnya pada subdimensi"
                            const separator = achievements.length > 0 ? `Namun, Ananda perlu meningkatkan fokus pada ` : `Area utama yang menjadi fokus pengembangan Ananda adalah `;
                            
                            // Hanya ambil dimensi unik dari focusAreas untuk menghindari pengulangan
                            const uniqueFocusDims = [...new Set(berkembang.map(d => d.dimName))];
                            const focusPhrases = uniqueFocusDims.map(dimName => {
                                // Cari semua target phrase untuk dimensi ini (hanya cakap/mahir goal)
                                const dimGoals = berkembang.filter(d => d.dimName === dimName).map(d => {
                                    const goalDesc = d.detail.cakap || d.detail.mahir;
                                    return `agar dapat *${getSimplifiedPhrase(goalDesc)}*`;
                                });
                                // Gabungkan menjadi satu kalimat per dimensi
                                return `dimensi **${dimName}** ${joinPhrases(dimGoals)}`;
                            });
                            
                            narasiInti += `${separator} ${joinPhrases(focusPhrases)} secara lebih konsisten.`;
                        } else if (achievements.length > 0) {
                            // If fully Mahir/Cakap, add a reinforcing sentence
                            narasiInti += "Penguasaan Ananda menunjukkan kematangan kompetensi yang sangat baik di seluruh aspek yang dinilai.";
                        }
                        
                        return narasiInti.trim();
                    };


                    const totalScore = allSubdimensiData.reduce((sum, d) => sum + d.score, 0);
                    const overallAverageScore = allSubdimensiData.length > 0 ? totalScore / allSubdimensiData.length : 0;
                    
                    // OPENING REMARKS (Variations for resynthesis)
                    let cyclingOpeningRemarks;
                    if (overallAverageScore >= 2.5) { // Mahir
                        cyclingOpeningRemarks = [
                            `Ananda ${nama} menunjukkan capaian yang sangat memuaskan dan pertumbuhan yang luar biasa selama mengikuti ${daftarKegiatanStr}.`,
                            `Kinerja Ananda ${nama} selama ${daftarKegiatanStr} senantiasa konsisten dan istimewa, menampilkan semangat belajar yang tinggi.`,
                            `Keterlibatan aktif dan penguasaan kompetensi yang cemerlang diperlihatkan oleh Ananda ${nama} dalam ${daftarKegiatanStr}.`,
                            `Ananda ${nama} menampilkan hasil perkembangan yang sangat mengesankan di sepanjang ${daftarKegiatanStr}, menunjukkan kematangan dalam kompetensi.`,
                            `Selama mengikuti ${daftarKegiatanStr}, Ananda ${nama} menunjukkan partisipasi yang luar biasa dan pemahaman yang mendalam terhadap materi.`
                        ];
                    } else if (overallAverageScore >= 1.5) { // Cakap
                        cyclingOpeningRemarks = [
                            `Ananda ${nama} telah berpartisipasi dengan penuh tanggung jawab dan memperlihatkan perkembangan positif yang baik selama mengikuti ${daftarKegiatanStr}.`,
                            `Sepanjang ${daftarKegiatanStr}, Ananda ${nama} menunjukkan keterlibatan yang konstruktif dan sikap belajar yang baik.`,
                            `Secara umum, Ananda ${nama} telah mengikuti seluruh rangkaian ${daftarKegiatanStr} dengan baik dan berhasil menunjukkan kemajuan yang nyata.`,
                            `Perkembangan kompetensi Ananda ${nama} dalam ${daftarKegiatanStr} menunjukkan arah positif dan kemampuan belajar yang adaptif.`,
                            `Ananda ${nama} telah berpartisipasi dengan antusiasme yang baik dalam ${daftarKegiatanStr} dan menunjukkan kemauan untuk terus maju.`
                        ];
                    } else { // Berkembang 
                         cyclingOpeningRemarks = [
                            `Ananda ${nama} menunjukkan potensi besar dan saat ini sedang dalam proses pengembangan yang memerlukan dukungan berkelanjutan selama ${daftarKegiatanStr}.`,
                            `Dalam mengikuti ${daftarKegiatanStr}, keterlibatan Ananda ${nama} perlu ditingkatkan secara konsisten untuk membangun motivasi belajar yang lebih kuat.`,
                            `Fokus dan partisipasi Ananda ${nama} selama ${daftarKegiatanStr} adalah area yang perlu mendapatkan perhatian khusus melalui bimbingan yang lebih personal.`,
                            `Selama ${daftarKegiatanStr}, Ananda ${nama} menunjukkan upaya, namun masih membutuhkan dorongan untuk terlibat lebih aktif dalam setiap proses pembelajaran.`,
                            `Keterlibatan Ananda ${nama} menunjukkan adanya tantangan, dan kami akan memberikan pendampingan yang intensif untuk peningkatan fokus dan motivasi dalam ${daftarKegiatanStr}.`
                        ];
                    }

                    // MODIFIKASI CLOSING REMARKS sesuai permintaan #4 (Tailored Closing)
                    // NEW: Function to return 5 varied motivational closings based on score (to ensure 5 unique variants)
                    const getMotivationalClosings = (score) => {
                        if (score >= 2.5) { // Mahir
                            return [
                                `Dukungan untuk Ananda dalam mempertahankan konsistensi dan mengambil peran kepemimpinan akan memantapkan capaian Mahir ini. Teruslah menjadi teladan yang menginspirasi, Ananda.`,
                                `Prestasi Ananda sangat memuaskan. Kami optimis Ananda dapat terus mengembangkan inisiatif dan menginspirasi teman-teman sebaya.`,
                                `Kemampuan Ananda berada di level Mahir. Mari dukung Ananda untuk terus mengasah kematangan dalam pengambilan keputusan dan kolaborasi yang lebih luas.`,
                                `Konsistensi Ananda patut diapresiasi. Fokus selanjutnya adalah memimpin proyek-proyek mandiri untuk menunjukkan potensi kepemimpinan yang utuh.`,
                                `Ananda telah mencapai penguasaan yang kuat. Dengan eksplorasi yang lebih mendalam, Ananda akan menjadi figur kunci dalam setiap kegiatan.`,
                            ];
                        } else if (score >= 1.5) { // Cakap
                            return [
                                // PERBAIKAN REDAKSI DI SINI: Mengubah tanda baca untuk kohesi
                                `Ananda telah mencapai tingkat Cakap yang baik dalam penguasaan kompetensi, sehingga dengan fokus dan ketekunan yang lebih terarah, Ananda akan segera mencapai tingkat Mahir di semua area yang ditekuni.`,
                                `Kami melihat kemauan besar pada Ananda dalam pengembangan diri, oleh karena itu dukungan untuk meningkatkan inisiatif mandiri akan membantu Ananda melangkah ke tingkat penguasaan yang lebih tinggi.`,
                                `Proses belajar Ananda sangat adaptif. Dengan memperkuat konsentrasi pada detail, Ananda akan mengubah capaian Cakap menjadi Mahir di semester berikutnya.`,
                                `Ananda memiliki dasar kompetensi yang kuat, sehingga perlu dorongan untuk lebih berani mengambil risiko positif dalam mencoba solusi-solusi baru.`,
                                `Teruslah berusaha, Ananda. Dengan mengoptimalkan waktu dan sumber daya, Ananda dapat memantapkan pemahaman dan menjadi lebih mandiri dalam tindakan.`,
                            ];
                        } else { // Berkembang
                            return [
                                `Kami percaya pada potensi Ananda. Dengan bimbingan intensif dan semangat untuk mengambil langkah kecil yang konsisten, Ananda pasti akan menunjukkan kemajuan yang signifikan.`,
                                `Area Berkembang ini adalah peluang emas bagi Ananda. Dengan meningkatkan fokus dan partisipasi aktif, Ananda akan segera mencapai tingkat Cakap.`,
                                `Perkembangan Ananda memerlukan perhatian khusus. Mari tingkatkan keterlibatan Ananda melalui kegiatan yang memicu rasa ingin tahu dan kolaborasi.`,
                                `Dukungan konsisten dari sekolah dan orang tua sangat penting. Kami berkomitmen memberikan pendampingan agar Ananda dapat menemukan motivasi internalnya.`,
                                `Setiap usaha kecil Ananda adalah langkah maju. Kami akan terus mendorong Ananda untuk berani bertanya dan mencari solusi dengan arahan minimal.`,
                            ];
                        }
                    };

                    const motivationalClosings = getMotivationalClosings(overallAverageScore);
                    
                    // Generate 5 variations using cycling opening and cycling closing for distinct variants
                    for (let i = 0; i < 5; i++) {
                        // Use both cycling opening and cycling closing for distinct variants
                        const opening = cyclingOpeningRemarks[i % cyclingOpeningRemarks.length];
                        const closing = motivationalClosings[i % motivationalClosings.length];
                        
                        // Generate core narrative based on achievement level for variation
                        const narasiInti = getCoreNarrative(
                            mahirSubdims, 
                            cakapSubdims, 
                            berkembangSubdims,
                            i // Pass variant index to influence structure
                        );

                        // Gabungkan semua bagian: Pembuka + Inti + Penutup Motivasi Tailored
                        let finalNarrative = `${opening} ${narasiInti} ${closing}`.replace(/\s+/g, ' ').trim();
                        
                        // Hapus titik ganda yang mungkin muncul
                        finalNarrative = finalNarrative.replace(/\.\s*\./g, '.');

                        narratives.push(finalNarrative);
                    }
                    
                    // Fallback if no data
                    if (allSubdimensiData.length === 0) {
                        narratives = [
                            `Ananda ${nama} terdaftar dalam kegiatan, namun belum ada data penilaian yang dapat diolah untuk menghasilkan narasi. Harap lengkapi data asesmen di tab Asesmen.`,
                            `Belum terdapat cukup data penilaian untuk Ananda ${nama} pada kegiatan yang diikuti. Harap lengkapi data asesmen di tab Asesmen.`,
                            `Data asesmen untuk Ananda ${nama} belum lengkap sehingga narasi otomatis tidak dapat dibuat. Harap lengkapi data asesmen di tab Asesmen.`
                        ];
                    }
                    
                    // Re-calculate narrative objects
                    const narrativeObjects = narratives.map(n => ({
                        // Convert markdown list and format to display HTML/clean text
                        html: n.replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold text-slate-900">$1</strong>').replace(/\*(.*?)\*/g, '<em class="italic text-slate-600">$1</em>'),
                        clean: n.replace(/[*_]/g, '') // For plain text export/copy
                    }));
                    
                    let initialNarrativeIndex = 0;
                    let finalNarrativeObjects = narrativeObjects;

                    const row = tbody.insertRow();
                    row.className = 'bg-white border-b hover:bg-slate-50';
                    // --- PERBAIKAN: Menetapkan dataset nama murid pada baris ---
                    row.dataset.namaMurid = nama; 
                    // --------------------------------------------------------
                    row.dataset.narratives = JSON.stringify(finalNarrativeObjects);
                    row.dataset.narrativeIndex = initialNarrativeIndex.toString();
                    // IKON DIUBAH DARI fas fa-robot MENJADI fas fa-brain
                    row.innerHTML = `<td class="px-6 py-4 font-medium text-slate-900 text-center">${muridIndex + 1}</td><td class="px-6 py-4 font-medium text-slate-900">${nama}</td><td class="px-6 py-4 align-top"><p class="narasi-p text-justify">${finalNarrativeObjects[initialNarrativeIndex]?.html || ''}</p></td>
                    <td class="px-6 py-4 text-center align-top"><div class="flex justify-center items-start space-x-1">
                        <div class="tooltip-container"><button class="ganti-narasi-btn p-2 text-slate-500 hover:text-sky-600" aria-label="Ganti variasi narasi untuk ${nama}"><i class="fas fa-sync-alt"></i></button><span class="tooltip" role="tooltip">Ganti variasi narasi</span></div>
                        <!-- IKON DIUBAH DARI fas fa-robot MENJADI fas fa-brain -->
                        <div class="tooltip-container"><button class="generate-ai-btn p-2 text-slate-500 hover:text-purple-600" aria-label="Generate AI narasi untuk ${nama}"><i class="fas fa-brain"></i></button><span class="tooltip" role="tooltip">Generate Narasi dengan AI</span></div>
                        <div class="tooltip-container"><button class="edit-narasi-btn p-2 text-slate-500 hover:text-blue-600" aria-label="Ubah narasi manual untuk ${nama}"><i class="fas fa-pencil-alt"></i></button><span class="tooltip" role="tooltip">Ubah narasi manual</span></div>
                        <div class="tooltip-container"><button class="simpan-narasi-btn p-2 text-slate-500 hover:text-green-600 hidden" aria-label="Simpan perubahan narasi untuk ${nama}"><i class="fas fa-check"></i></button><span class="tooltip" role="tooltip">Simpan perubahan</span></div>
                        <div class="tooltip-container"><button class="copy-btn p-2 text-slate-500 hover:text-sky-600" aria-label="Salin narasi untuk ${nama}"><i class="far fa-copy"></i></button><span class="tooltip" role="tooltip">Salin teks narasi</span></div>
                    </div></td>`;
                });
            };
            
            renderTableBody();

            sortHeader.addEventListener('click', () => {
                sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
                renderTableBody();
            });

            page.querySelector('#resintesis-btn').addEventListener('click', () => {
                tbody.querySelectorAll('tr').forEach(row => {
                    if (row.dataset.narratives) {
                        let currentIndex = parseInt(row.dataset.narrativeIndex, 10);
                        const narratives = JSON.parse(row.dataset.narratives);
                        currentIndex = (currentIndex + 1) % narratives.length;
                        const newNarrative = narratives[currentIndex];
                        const p = row.querySelector('.narasi-p'); // Find p inside loop
                        p.innerHTML = newNarrative.html;
                        row.dataset.narrativeIndex = currentIndex;
                    }
                });
            });

            // NEW: Generate AI All listener
            page.querySelector('#generate-ai-all-btn').addEventListener('click', async (e) => {
                const btn = e.target.closest('#generate-ai-all-btn');
                const originalText = btn.innerHTML;
                
                // Pastikan API Key ada sebelum memulai proses
                if (!identitasData.geminiApiKey) {
                    showNotification("Kunci API Gemini belum dimasukkan. Silakan masukkan di bagian 'Pengaturan Kunci API Gemini'.");
                    return;
                }
                
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Memproses Semua...';
                
                const rows = Array.from(tbody.querySelectorAll('tr'));
                let successCount = 0;
                let errorCount = 0;
                
                for (const row of rows) {
                    const nama = row.dataset.namaMurid;
                    if (nama) {
                         try {
                            // Tambahkan delay agar tidak terlalu cepat memanggil API
                            await new Promise(res => setTimeout(res, 500));
                            
                            const rowBtn = row.querySelector('.generate-ai-btn');
                            const rowOriginalIcon = rowBtn.innerHTML;
                            rowBtn.disabled = true;
                            rowBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                            const promptData = prepareAIPromptData(nama);
                            if (promptData) {
                                await generateAINarrative(row);
                                successCount++;
                            } else {
                                // Murid ini tidak punya data asesmen, lewati
                            }
                            
                            rowBtn.disabled = false;
                            rowBtn.innerHTML = rowOriginalIcon;

                        } catch (error) {
                            errorCount++;
                            const rowBtn = row.querySelector('.generate-ai-btn');
                            rowBtn.disabled = false;
                            rowBtn.innerHTML = rowOriginalIcon;
                            console.error("Batch AI Generation Failed for:", nama, error);
                        }
                    }
                }
                
                btn.disabled = false;
                btn.innerHTML = originalText;
                
                // HANYA MUNCULKAN KEBERHASILAN DI AKHIR (Permintaan sebelumnya)
                let message = `Sintesis AI untuk ${successCount} murid berhasil dibuat.`;
                if (errorCount > 0) {
                     message += ` Terdapat ${errorCount} kesalahan/kegagalan AI. Cek Kunci API dan koneksi Anda.`;
                }
                showNotification(message);
                saveState();
            });

            page.addEventListener('click', e => {
                const btn = e.target.closest('button');
                if (!btn) return;

                if (btn.id === 'ekspor-hasil-btn') {
                    openModal(DOMElements.eksporLaporanModal);
                    return;
                }

                const row = btn.closest('tr');
                if (!row) return;

                const p = row.querySelector('.narasi-p');

                if (btn.classList.contains('generate-ai-btn')) {
                    generateAINarrative(row);
                    return;
                }

                if (btn.classList.contains('copy-btn')) {
                    // Use execCommand('copy') for iFrame compatibility
                    const tempTextArea = document.createElement('textarea');
                    tempTextArea.value = p.innerText;
                    document.body.appendChild(tempTextArea);
                    tempTextArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempTextArea);

                    btn.innerHTML = '<i class="fas fa-check text-green-500"></i>';
                    setTimeout(() => btn.innerHTML = '<i class="far fa-copy"></i>', 2000);
                } else if (btn.classList.contains('ganti-narasi-btn')) {
                    let currentIndex = parseInt(row.dataset.narrativeIndex, 10);
                    const narratives = JSON.parse(row.dataset.narratives);
                    currentIndex = (currentIndex + 1) % narratives.length;
                    const newNarrative = narratives[currentIndex];
                    p.innerHTML = newNarrative.html;
                    row.dataset.narrativeIndex = currentIndex;
                } else if (btn.classList.contains('edit-narasi-btn')) {
                    p.contentEditable = true;
                    p.classList.add('bg-sky-50', 'p-2', 'rounded-md', 'outline-sky-300');
                    p.focus();
                    btn.classList.add('hidden');
                    row.querySelector('.simpan-narasi-btn').classList.remove('hidden');
                } else if (btn.classList.contains('simpan-narasi-btn')) {
                    p.contentEditable = false;
                    p.classList.remove('bg-sky-50', 'p-2', 'rounded-md', 'outline-sky-300');
                    let currentIndex = parseInt(row.dataset.narrativeIndex, 10);
                    let narratives = JSON.parse(row.dataset.narratives);
                    narratives[currentIndex] = { 
                        html: p.innerHTML, 
                        clean: p.innerText,
                        // Mark as user-edited if it was an automatically generated one
                        userEdited: true,
                        aiGenerated: narratives[currentIndex].aiGenerated || false
                    };
                    row.dataset.narratives = JSON.stringify(narratives);
                    saveState();
                    btn.classList.add('hidden');
                    row.querySelector('.edit-narasi-btn').classList.remove('hidden');
                }
            });
        };
        
        // Modified getExportData
        const getExportData = () => {
            const table = document.getElementById('hasil-table');
            if (!table || table.querySelectorAll('tbody tr').length === 0 || table.querySelector('tbody td[colspan="4"]')) {
                showNotification("Tidak ada data untuk diekspor. Harap isi data asesmen, lalu klik tombol 'Sintesis & Lihat Hasil' di tab Asesmen.");
                return null;
            }

            const allSubdimensi = [];
            const subdimensiSet = new Set();
            Object.entries(kegiatanData).forEach(([kegiatanId, kegiatan]) => {
                Object.entries(kegiatan.dims).forEach(([dimId, dim]) => {
                    dim.subdims.forEach((subdim, subdimIndex) => {
                        const headerText = `${kegiatan.name} - ${dim.name} - ${subdim.name}`;
                        if (!subdimensiSet.has(headerText)) {
                            subdimensiSet.add(headerText);
                            allSubdimensi.push({
                                header: headerText,
                                kegiatanId,
                                dimId,
                                subdimIndex
                            });
                        }
                    });
                });
            });

            const headers = ['No', 'Nama Murid', ...allSubdimensi.map(a => a.header), 'Capaian Kompetensi'];
            const body = [];
            table.querySelectorAll('tbody tr').forEach(row => {
                const noCell = row.cells[0];
                const namaCell = row.cells[1];
                const narasiCell = row.querySelector('.narasi-p');

                if (noCell && namaCell && narasiCell) {
                    const no = noCell.innerText;
                    const nama = namaCell.innerText;
                    
                    // Get the currently displayed narrative (clean text)
                    const narasi = narasiCell.innerText;

                    if (nama && narasi) {
                        const dataRow = [no, nama];
                        allSubdimensi.forEach(subdim => {
                            const scoreKey = muridData[nama]?.[subdim.kegiatanId]?.[subdim.dimId]?.[subdim.subdimIndex] || '';
                            dataRow.push(scoreKey); // Export M/C/B string
                        });
                        dataRow.push(narasi);
                        body.push(dataRow);
                    }
                }
            });

            if (body.length === 0) {
                showNotification("Tidak ada data laporan yang valid untuk diekspor.");
                return null;
            }
            
            return { headers, body };
        };

        const handleExportExcel = () => {
            const exportData = getExportData();
            if (!exportData) return;

            const { body } = exportData; // We only need the body, headers will be custom built
            const originalHeaders = getExportData().headers; // Get original headers for parsing

            const workbook = XLSX.utils.book_new();
            
            // --- NEW LOGIC: Build Multi-level, Merged Headers for Excel ---
            const structuredHeaders = {};
            // Parse original flat headers into a nested object structure
            for (let i = 2; i < originalHeaders.length - 1; i++) {
                const parts = originalHeaders[i].split(' - ');
                const kegiatan = parts[0] || 'Lainnya';
                const dimensi = parts[1] || 'Lainnya';
                const subdimensi = parts[2] || 'Subdimensi';

                if (!structuredHeaders[kegiatan]) structuredHeaders[kegiatan] = {};
                if (!structuredHeaders[kegiatan][dimensi]) structuredHeaders[kegiatan][dimensi] = [];
                structuredHeaders[kegiatan][dimensi].push(subdimensi);
            }

            const headerRow1 = ['No', 'Nama Murid'];
            const headerRow2 = [null, null]; // Placeholders for merged cells
            const merges = [
                { s: { r: 0, c: 0 }, e: { r: 1, c: 0 } }, // Merge 'No' cell (Changed from r:2 to r:1)
                { s: { r: 0, c: 1 }, e: { r: 1, c: 1 } }  // Merge 'Nama Murid' cell (Changed from r:2 to r:1)
            ];

            let currentColumn = 2;
            Object.keys(structuredHeaders).forEach(kegiatanName => {
                const startKegiatanCol = currentColumn;
                headerRow1.push(kegiatanName);
                
                Object.keys(structuredHeaders[kegiatanName]).forEach(dimensiName => {
                    const subdimensiList = structuredHeaders[kegiatanName][dimensiName];
                    subdimensiList.forEach((subdimensiName, index) => {
                        headerRow2.push(`${dimensiName} - ${subdimensiName}`);
                    });
                    
                    currentColumn += subdimensiList.length;
                });
                
                const endKegiatanCol = currentColumn - 1;
                if (endKegiatanCol > startKegiatanCol) {
                    merges.push({ s: { r: 0, c: startKegiatanCol }, e: { r: 0, c: endKegiatanCol } });
                }
                 // Add placeholders for the merged kegiatan cells
                for(let i = startKegiatanCol + 1; i <= endKegiatanCol; i++) {
                    headerRow1.push(null);
                }
            });

            headerRow1.push('Capaian Kompetensi');
            headerRow2.push('Capaian Kompetensi');
            merges.push({ s: { r: 0, c: currentColumn }, e: { r: 1, c: currentColumn } }); // Changed from r:2 to r:1
            
            const ws = {}; // Create an empty worksheet object

            const headerStyle = {
                font: { bold: true },
                alignment: { vertical: 'center', horizontal: 'center', wrapText: true }
            };

            const headerRows = [headerRow1, headerRow2]; // Only two rows
            for (let r = 0; r < headerRows.length; r++) {
                for (let c = 0; c < headerRow1.length; c++) {
                    const cellAddress = XLSX.utils.encode_cell({ r, c });
                    const cell = {
                        s: headerStyle,
                        t: 's'
                    };
                    const value = headerRows[r][c];
                    if (value !== null) {
                        cell.v = value;
                    }
                    ws[cellAddress] = cell;
                }
            }

            body.forEach((row, r_offset) => {
                const r = r_offset + 2; // Data starts at row 2 (0-indexed)
                row.forEach((value, c) => {
                    const cellAddress = XLSX.utils.encode_cell({ r, c });
                    const cell = { v: value, t: 's' };
                    if (c === headerRow1.length - 1) {
                        cell.s = { alignment: { wrapText: true, vertical: 'top' } };
                    }
                    ws[cellAddress] = cell;
                });
            });
            
            const range = { s: { c: 0, r: 0 }, e: { c: headerRow1.length - 1, r: body.length + 1 } }; // Changed r:body.length + 2 to + 1
            ws['!ref'] = XLSX.utils.encode_range(range);
            ws['!merges'] = merges;

            const colWidths = [
                { wch: 5 }, 
                { wch: 30 }, 
                ...Array(originalHeaders.length - 3).fill({ wch: 20 }),
                { wch: 100 } 
            ];
            ws['!cols'] = colWidths;
            
            XLSX.utils.book_append_sheet(workbook, ws, 'Hasil Sintesis Lengkap');
            const filename = `Edi Brata_Kokurikuler_Hasil Sintesis_${getFormattedTimestamp(true)}.xlsx`;
            XLSX.writeFile(workbook, filename);
            showNotification("Laporan berhasil diekspor ke file Excel.");
        };

        const handleExportPdf = () => {
            const exportData = getExportData();
            if (!exportData) return;

            const { body } = exportData; 
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
            
            const totalPagesExp = '{totalPages}';

            const structuredHeaders = {};
            const originalHeaders = getExportData().headers; 

            for (let i = 2; i < originalHeaders.length - 1; i++) {
                const parts = originalHeaders[i].split(' - ');
                const kegiatan = parts[0] || 'Lainnya';
                const dimensi = parts[1] || 'Lainnya';
                const subdimensi = parts[2] || 'Subdimensi';

                if (!structuredHeaders[kegiatan]) structuredHeaders[kegiatan] = {};
                if (!structuredHeaders[kegiatan][dimensi]) structuredHeaders[kegiatan][dimensi] = [];
                structuredHeaders[kegiatan][dimensi].push(subdimensi);
            }

            const headerRow1 = [{ content: 'No', rowSpan: 2 }, { content: 'Nama Murid', rowSpan: 2 }]; // Changed rowspan to 2
            const headerRow2 = [];

            Object.keys(structuredHeaders).forEach(kegiatanName => {
                let kegiatanColSpan = 0;
                Object.keys(structuredHeaders[kegiatanName]).forEach(dimensiName => {
                    const subdimensiList = structuredHeaders[kegiatanName][dimensiName];
                    subdimensiList.forEach((subdimensiName) => {
                        kegiatanColSpan += 1;
                        headerRow2.push({ content: `${dimensiName} - ${subdimensiName}` });
                    });
                });
                headerRow1.push({ content: kegiatanName, colSpan: kegiatanColSpan });
            });
            
            headerRow1.push({ content: 'Capaian Kompetensi', rowSpan: 2 }); // Changed rowspan to 2
            const finalPdfHeaders = [headerRow1, headerRow2];

            const columnStyles = {
                 0: { cellWidth: 8, halign: 'center' },
                 1: { cellWidth: 35 },
                 [originalHeaders.length - 1]: { cellWidth: 'auto' }
            };
            
             for (let i = 2; i < originalHeaders.length - 1; i++) {
                columnStyles[i] = { halign: 'center' };
            }

            let pdfTitle = `Laporan Hasil Kegiatan Kokurikuler Kelas ${identitasData.kelas || '[Kelas]'}`;
            if (identitasData.rombel && identitasData.rombel !== 'Hanya Satu') {
                pdfTitle += `/${identitasData.rombel}`;
            }
            pdfTitle += ` ${identitasData.namaSekolah || '[Nama Sekolah]'}`;
            pdfTitle = pdfTitle.toUpperCase();
            
            const pageMargin = 10;
            
            doc.autoTable({
                head: finalPdfHeaders,
                body: body,
                startY: 20,
                theme: 'grid',
                margin: { top: 20, right: pageMargin, bottom: 15, left: pageMargin },
                headStyles: { fillColor: [22, 160, 133], fontSize: 7, cellPadding: 1.5, halign: 'center', valign: 'middle', lineWidth: 0.1 },
                styles: { fontSize: 7, cellPadding: 1, lineWidth: 0.1 },
                columnStyles: columnStyles,
                didDrawPage: function (data) {
                    const pageWidth = doc.internal.pageSize.width;
                    doc.setFontSize(14);
                    doc.setTextColor(40);
                    doc.text(pdfTitle, pageWidth / 2, 15, { align: 'center' });
                    
                    let footerStr = "Halaman " + doc.internal.getCurrentPageInfo().pageNumber;
                    if (typeof doc.putTotalPages === 'function') {
                        footerStr = footerStr + " dari " + totalPagesExp;
                    }
                    doc.setFontSize(8);
                    
                    const pageHeight = doc.internal.pageSize.height;
                    doc.text(footerStr, pageWidth / 2, pageHeight - 10, { align: 'center' });
                }
            });

            let finalY = doc.lastAutoTable && doc.lastAutoTable.finalY ? doc.lastAutoTable.finalY : 20;

            if (finalY > doc.internal.pageSize.height - 60) {
                doc.addPage();
                finalY = 20;
            } else {
                finalY += 10;
            }
            
            const today = new Date();
            const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            const formattedDate = `${today.getDate()} ${months[today.getMonth()]} ${today.getFullYear()}`;
            
            const signatureLocation = identitasData.namaKabupatenKota || '[Kabupaten/Kota]';
            const pageWidth = doc.internal.pageSize.width;
            
            const signatureX_left = pageMargin + 45;
            const signatureX_right = pageWidth - pageMargin - 70;

            doc.setFontSize(10);

            doc.text('Mengetahui:', signatureX_left, finalY);
            doc.text('Kepala Sekolah,', signatureX_left, finalY + 5);
            doc.text(identitasData.kepalaSekolah || '[Nama Kepala Sekolah]', signatureX_left, finalY + 25);
            doc.text(`NIP. ${identitasData.nipKepsek || '[NIP Kepala Sekolah]'}`, signatureX_left, finalY + 30);
            
            doc.text(`${signatureLocation}, ${formattedDate}`, signatureX_right, finalY);
            doc.text('Guru,', signatureX_right, finalY + 5);
            doc.text(identitasData.guruKelas || '[Nama Guru]', signatureX_right, finalY + 25);
            doc.text(`NIP. ${identitasData.nipGuru || '[NIP Guru]'}`, signatureX_right, finalY + 30);

            if (typeof doc.putTotalPages === 'function') {
                doc.putTotalPages(totalPagesExp);
            }

            const filename = `Edi Brata_Kokurikuler_Hasil Sintesis_${getFormattedTimestamp(true)}.pdf`;
            doc.save(filename);
            showNotification("Laporan berhasil diekspor ke file PDF.");
        };

        const handlePerancanganClick = (e) => {
            const button = e.target.closest('button');
            const card = e.target.closest('.kegiatan-card, .dimensi-block, .subdimensi-item'); // Changed target to subdimensi-item
            const header = e.target.closest('.kegiatan-header');
            
            // Remove check for generate-aspek-btn

            if (button && button.classList.contains('hapus-kegiatan')) card.remove();
            else if (button && button.classList.contains('hapus-dimensi')) card.remove();
            // Remove checks for hapus-tujuan, hapus-aspek, tambah-tujuan, tambah-aspek
            else if (button && button.classList.contains('tambah-dimensi')) tambahDimensi(button);
            else if (header) {
                const body = header.nextElementSibling;
                const icon = header.querySelector('.toggle-icon');
                const isExpanded = body.classList.toggle('open');
                header.setAttribute('aria-expanded', isExpanded);
                icon.classList.toggle('rotate-180', isExpanded);
            }
        };

        // --- Identitas Tab Functions (No major change, keeping for context) ---
        
        const sendToGoogleSheet = (data) => {
            const scriptURL = 'https://script.google.com/macros/s/AKfycbxL9d0lgzTSsxTSmUPBKdXXdJIaf-wzom_MVTCETxyN58u_M0sNb1AleFYET5HaELH2Bg/exec';
            const formData = new FormData();
            for (const key in data) {
                formData.append(key, data[key]);
            }

            fetch(scriptURL, { method: 'POST', body: formData})
                .then(response => {
                    if (response.ok) {
                        console.log('Data berhasil terkirim ke Google Sheet.');
                    } else {
                        console.error('Gagal mengirim data ke Google Sheet. Status:', response.statusText);
                    }
                })
                .catch(error => console.error('Error saat mengirim data ke Google Sheet:', error.message));
        };

        const handleIdentitasTemplate = () => {
            const workbook = XLSX.utils.book_new();
            const headers = [
                'namaSekolah', 'npsn', 'alamat', 'desaKelurahanSelect', 'namaDesaKelurahan',
                'kecamatan', 'kabupatenKotaSelect', 'namaKabupatenKota', 'provinsi',
                'kelas', 'rombel', 'kepalaSekolah', 'nipKepsek', 'waKepsek',
                'guruKelas', 'nipGuru', 'waGuru'
            ];
            const exampleRow = [
                'SDN CONTOH 1', '12345678', 'Jl. Pendidikan No. 1', 'Desa', 'Cinta Damai',
                'Kec. Harapan', 'Kabupaten', 'Maju Jaya', 'Banten',
                '4', 'A', 'Drs. Budi Santoso, M.Pd.', '196501011990031001', '081234567890',
                'Siti Aminah, S.Pd.', '198502022010012002', '089876543210'
            ];

            const data = [headers, exampleRow];
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = headers.map(() => ({ wch: 25 }));
            XLSX.utils.book_append_sheet(workbook, ws, 'Identitas');
            const filename = `Edi Brata_Kokurikuler_Identitas_Template_${getFormattedTimestamp(true)}.xlsx`;
            XLSX.writeFile(workbook, filename);
            showNotification("Template Identitas berhasil diunduh.");
        };

        const handleIdentitasExport = () => {
            simpanIdentitas();
            if (Object.values(identitasData).every(val => !val)) {
                showNotification('Data identitas masih kosong sehingga tidak dapat diekspor. Silakan lengkapi formulir di tab \'Identitas\' terlebih dahulu.');
                return;
            }
            const workbook = XLSX.utils.book_new();
            const headers = [
                'namaSekolah', 'npsn', 'alamat', 'desaKelurahanSelect', 'namaDesaKelurahan',
                'kecamatan', 'kabupatenKotaSelect', 'namaKabupatenKota', 'provinsi',
                'kelas', 'rombel', 'kepalaSekolah', 'nipKepsek', 'waKepsek',
                'guruKelas', 'nipGuru', 'waGuru'
            ];
            
            const rowData = headers.map(header => identitasData[header] || '');

            const data = [headers, rowData];
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = headers.map(() => ({ wch: 25 }));
            XLSX.utils.book_append_sheet(workbook, ws, 'Identitas');
            const filename = `Edi Brata_Kokurikuler_Identitas_Ekspor_${getFormattedTimestamp(true)}.xlsx`;
            XLSX.writeFile(workbook, filename);
            showNotification("Data Identitas berhasil diekspor.");
        };

        const handleIdentitasImport = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const workbook = XLSX.read(e.target.result, { type: 'array' });
                    const ws = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(ws, { header: 1 });

                    if (json.length < 2) {
                        showNotification('File Excel kosong atau tidak memiliki baris data.');
                        return;
                    }

                    const headers = json[0].map(h => String(h || '').trim());
                    const dataRow = json[1].map(d => (d !== null && d !== undefined) ? String(d).trim() : '');

                    const newIdentitasData = {};
                    headers.forEach((header, index) => {
                        if (header) { newIdentitasData[header] = dataRow[index] || ''; }
                    });

                    if (Object.keys(newIdentitasData).length === 0) {
                        showNotification('Gagal mengimpor data. Pastikan header pada file Excel cocok dengan template.');
                        return;
                    }
                    
                    // Preserve existing geminiApiKey if not present in imported data
                    newIdentitasData.geminiApiKey = identitasData.geminiApiKey || newIdentitasData.geminiApiKey || '';
                    
                    identitasData = newIdentitasData;
                    renderIdentitasPage(); 
                    saveIdentitasStateToHistory(identitasData);
                    
                    const validation = validateIdentitasForm();
                    if (validation.isValid) {
                        isIdentitasComplete = true;
                        saveState();
                        updateTabLockState();
                        showNotification('Data identitas berhasil diimpor dan disimpan.');
                    } else {
                        isIdentitasComplete = false;
                        saveState();
                        updateTabLockState();
                        const message = `Data identitas telah dimuat, namun beberapa bagian masih kosong:\n\n• ${validation.emptyFields.join('\n• ')}\n\nHarap lengkapi dan klik "Simpan".`;
                        showNotification(message);
                    }
                } catch (err) {
                    showNotification('Gagal memuat file. Pastikan file Excel yang Anda unggah sesuai dengan format template.');
                    console.error("Identitas Import error:", err);
                }
            };
            reader.readAsArrayBuffer(file);
            event.target.value = null;
        };

        const simpanIdentitas = () => {
            const form = document.getElementById('identitas-form');
            if (!form) return;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            // Make sure to preserve geminiApiKey if it exists outside the form
            data.geminiApiKey = identitasData.geminiApiKey || data.geminiApiKey || '';
            identitasData = data;
        };
        
        const validateIdentitasForm = () => {
            const form = document.getElementById('identitas-form');
            if (!form) return { isValid: false, emptyFields: ['Form tidak ditemukan'], invalidFields: [] };

            const emptyFields = new Set();
            const invalidFields = new Set();
            const inputs = form.querySelectorAll('input[name], select[name]');
            let isValid = true;
            const waPattern = /^08[1-9][0-9]{7,10}$/; // Format nomor WA Indonesia (08xx, total 10-13 digit)


            inputs.forEach(input => {
                if (!input.value || input.value.trim() === '') {
                    isValid = false;
                    let label = form.querySelector(`label[for="${input.id}"]`);
                    let labelText = label ? label.textContent.trim() : (input.placeholder || input.name);

                    if (input.name === 'namaDesaKelurahan' || input.name === 'desaKelurahanSelect') {
                        labelText = 'Desa/Kelurahan';
                    } else if (input.name === 'namaKabupatenKota' || input.name === 'kabupatenKotaSelect') {
                        labelText = 'Kabupaten/Kota';
                    }
                    
                    emptyFields.add(labelText);
                }
                
                // Validasi format nomor WhatsApp
                if (input.name === 'waKepsek' || input.name === 'waGuru') {
                    const waValue = input.value.trim();
                    if (waValue && !waPattern.test(waValue)) {
                        isValid = false;
                        let labelText = form.querySelector(`label[for="${input.id}"]`).textContent.trim();
                        invalidFields.add(labelText);
                    }
                }
            });

            return { isValid, emptyFields: Array.from(emptyFields), invalidFields: Array.from(invalidFields) };
        };

        const renderIdentitasPage = () => {
            const page = DOMElements.tabContents.identitas;
            const kelasOptions = Array.from({length: 12}, (_, i) => i + 1).map(k => `<option value="${k}" ${identitasData.kelas == k ? 'selected' : ''}>${k}</option>`).join('');
            const rombelOptionsList = ["Hanya Satu", ...Array.from({length: 15}, (_, i) => String.fromCharCode(65 + i))];
            const rombelOptions = rombelOptionsList.map(r => `<option value="${r}" ${identitasData.rombel == r ? 'selected' : ''}>${r}</option>`).join('');
            
            const desaKelurahanOptions = `
                <option value="" ${!identitasData.desaKelurahanSelect ? 'selected' : ''}>Pilih</option>
                <option value="Desa" ${identitasData.desaKelurahanSelect === 'Desa' ? 'selected' : ''}>Desa</option>
                <option value="Kelurahan" ${identitasData.desaKelurahanSelect === 'Kelurahan' ? 'selected' : ''}>Kelurahan</option>
            `;
             const kabupatenKotaOptions = `
                <option value="" ${!identitasData.kabupatenKotaSelect ? 'selected' : ''}>Pilih</option>
                <option value="Kabupaten" ${identitasData.kabupatenKotaSelect === 'Kabupaten' ? 'selected' : ''}>Kabupaten</option>
                <option value="Kota" ${identitasData.kabupatenKotaSelect === 'Kota' ? 'selected' : ''}>Kota</option>
            `;

            page.innerHTML = `
            <div class="max-w-4xl mx-auto space-y-4 text-gray-700 font-sans">
                <!-- Buttons -->
                <div class="flex flex-wrap justify-between items-center gap-3 mb-6">
                    <div class="flex items-center gap-2">
                        <div class="tooltip-container">
                            <button id="template-identitas-btn" type="button" class="inline-flex items-center justify-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-blue-700">
                                <i class="fas fa-file-excel mr-2"></i>Template
                            </button>
                            <span class="tooltip" role="tooltip">Unduh templat Excel untuk data identitas</span>
                        </div>
                        <div class="tooltip-container">
                            <button id="ekspor-identitas-btn" type="button" class="inline-flex items-center justify-center px-4 py-2 bg-teal-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-teal-700">
                                <i class="fas fa-file-export mr-2"></i>Ekspor
                            </button>
                            <span class="tooltip" role="tooltip">Ekspor data identitas saat ini ke file Excel</span>
                        </div>
                        <div class="tooltip-container">
                            <button id="impor-identitas-btn" type="button" class="inline-flex items-center justify-center px-4 py-2 bg-slate-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-slate-700">
                                <i class="fas fa-file-import mr-2"></i>Impor
                            </button>
                            <span class="tooltip" role="tooltip">Impor data identitas dari file Excel</span>
                        </div>
                        <input type="file" id="import-identitas-file-input" class="hidden" accept=".xlsx, .xls">
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="tooltip-container">
                             <button id="undo-identitas-btn" type="button" class="murid-table-btn text-slate-600" aria-label="Undo"><i class="fas fa-undo-alt"></i></button>
                             <span class="tooltip" role="tooltip">Batalkan (Undo)</span>
                        </div>
                        <div class="tooltip-container">
                             <button id="redo-identitas-btn" type="button" class="murid-table-btn text-slate-600" aria-label="Redo"><i class="fas fa-redo-alt"></i></button>
                             <span class="tooltip" role="tooltip">Ulangi (Redo)</span>
                        </div>
                        <div class="tooltip-container">
                            <button id="reset-identitas-btn" type="button" class="inline-flex items-center justify-center px-4 py-2 bg-amber-500 text-white text-sm font-medium rounded-md shadow-sm hover:bg-amber-600 gap-2">
                                <i class="fas fa-undo-alt"></i> Reset
                            </button>
                            <span class="tooltip" role="tooltip">Reset semua isian pada formulir ini</span>
                        </div>
                        <div class="tooltip-container">
                            <button id="simpan-identitas-btn" type="button" class="inline-flex items-center justify-center px-4 py-2 bg-sky-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-sky-700 gap-2">
                                <i class="fas fa-save"></i> Simpan
                            </button>
                            <span class="tooltip" role="tooltip">Simpan data identitas</span>
                        </div>
                    </div>
                </div>
                
                <form id="identitas-form" class="space-y-4">
                    <!-- Satuan Pendidikan Accordion -->
                    <div class="border border-gray-300 rounded-md">
                        <div id="accordion-header-sekolah" aria-expanded="true" aria-controls="accordion-body-sekolah" class="identitas-section-header flex justify-between items-center p-4 rounded-t-md">
                            <h2 class="flex items-center text-gray-900 font-semibold text-base">
                                <i class="fas fa-school text-indigo-700 text-lg mr-3"></i>Satuan Pendidikan
                            </h2>
                            <i class="identitas-toggle-icon fas fa-chevron-down text-gray-500"></i>
                        </div>
                        <div id="accordion-body-sekolah" role="region" aria-labelledby="accordion-header-sekolah" class="identitas-section-body open space-y-5 px-4">
                             <div class="flex flex-wrap md:flex-nowrap gap-4">
                                <div class="w-full md:w-3/4">
                                    <label class="text-xs font-semibold text-gray-700 block mb-1" for="namaSekolah">Nama Sekolah</label>
                                    <input id="namaSekolah" name="namaSekolah" type="text" value="${identitasData.namaSekolah || ''}" placeholder="Masukkan nama sekolah lengkap" class="w-full border border-gray-300 rounded-md px-3 py-2 text-xs placeholder:text-gray-400 focus:outline-none focus:ring-1 focus:ring-indigo-600"/>
                                </div>
                                <div class="w-full md:w-1/4">
                                    <label class="text-xs font-semibold text-gray-700 block mb-1" for="npsn">NPSN</label>
                                    <input id="npsn" name="npsn" type="text" value="${identitasData.npsn || ''}" placeholder="Nomor Pokok Sekolah" class="w-full border border-gray-300 rounded-md px-3 py-2 text-xs placeholder:text-gray-400 focus:outline-none focus:ring-1 focus:ring-indigo-600"/>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-gray-700 block mb-1" for="alamat">Alamat</label>
                                <input id="alamat" name="alamat" type="text" value="${identitasData.alamat || ''}" placeholder="Alamat lengkap sekolah" class="w-full border border-gray-300 rounded-md px-3 py-2 text-xs placeholder:text-gray-400 focus:outline-none focus:ring-1 focus:ring-indigo-600"/>
                            </div>
                            <div class="flex flex-wrap md:flex-nowrap gap-4">
                                <div class="w-full md:w-1/2 space-y-5">
                                    <div>
                                        <label class="text-xs font-semibold text-gray-700 block mb-1" for="desaKelurahan">Desa/Kelurahan</label>
                                        <div class="flex gap-2">
                                            <select id="desaKelurahan" name="desaKelurahanSelect" class="w-1/3 border border-gray-300 rounded-md px-3 py-2 text-xs text-gray-700 focus:outline-none focus:ring-1 focus:ring-indigo-600">${desaKelurahanOptions}</select>
                                            <input id="namaDesa" name="namaDesaKelurahan" type="text" value="${identitasData.namaDesaKelurahan || ''}" placeholder="Nama" class="w-2/3 border border-gray-300 rounded-md px-3 py-2 text-xs placeholder:text-gray-400 focus:outline-none focus:ring-1 focus:ring-indigo-600"/>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-xs font-semibold text-gray-700 block mb-1" for="kabupatenKota">Kabupaten/Kota</label>
                                        <div class="flex gap-2">
                                            <select id="kabupatenKota" name="kabupatenKotaSelect" class="w-1/3 border border-gray-300 rounded-md px-3 py-2 text-xs text-gray-700 focus:outline-none focus:ring-1 focus:ring-indigo-600">${kabupatenKotaOptions}</select>
                                            <input id="namaKabupaten" name="namaKabupatenKota" type="text" value="${identitasData.namaKabupatenKota || ''}" placeholder="Nama" class="w-2/3 border border-gray-300 rounded-md px-3 py-2 text-xs placeholder:text-gray-400 focus:outline-none focus:ring-1 focus:ring-indigo-600"/>
                                        </div>
                                    </div>
                                </div>
                                <div class="w-full md:w-1/2 space-y-5">
                                    <div>
                                        <label class="text-xs font-semibold text-gray-700 block mb-1" for="kecamatan">Kecamatan</label>
                                        <input id="kecamatan" name="kecamatan" type="text" value="${identitasData.kecamatan || ''}" placeholder="Nama kecamatan" class="w-full border border-gray-300 rounded-md px-3 py-2 text-xs placeholder:text-gray-400 focus:outline-none focus:ring-1 focus:ring-indigo-600"/>
                                    </div>
                                    <div>
                                        <label class="text-xs font-semibold text-gray-700 block mb-1" for="provinsi">Provinsi</label>
                                        <input id="provinsi" name="provinsi" type="text" value="${identitasData.provinsi || ''}" placeholder="Nama provinsi" class="w-full border border-gray-300 rounded-md px-3 py-2 text-xs placeholder:text-gray-400 focus:outline-none focus:ring-1 focus:ring-indigo-600"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Kelas dan Rombel Accordion -->
                     <div class="border border-gray-300 rounded-md">
                        <div id="accordion-header-kelas" aria-expanded="false" aria-controls="accordion-body-kelas" class="identitas-section-header flex justify-between items-center p-4">
                             <h2 class="flex items-center text-gray-900 font-semibold text-base">
                                <i class="fas fa-desktop text-indigo-700 text-lg mr-3"></i>Kelas dan Rombel
                            </h2>
                            <i class="identitas-toggle-icon fas fa-chevron-down text-gray-500"></i>
                        </div>
                        <div id="accordion-body-kelas" role="region" aria-labelledby="accordion-header-kelas" class="identitas-section-body px-4">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-5 max-w-4xl">
                                <div>
                                    <label class="text-xs font-semibold text-gray-700 block mb-1" for="kelas">Kelas</label>
                                    <select id="kelas" name="kelas" class="w-full border border-gray-300 rounded-md px-3 py-2 text-xs text-gray-700 focus:outline-none focus:ring-1 focus:ring-indigo-600">
                                        <option value="">Pilih Kelas</option>
                                        ${kelasOptions}
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-semibold text-gray-700 block mb-1" for="rombel">Ruang Rombel</label>
                                    <select id="rombel" name="rombel" class="w-full border border-gray-300 rounded-md px-3 py-2 text-xs text-gray-700 focus:outline-none focus:ring-1 focus:ring-indigo-600">
                                        <option value="">Pilih Rombel</option>
                                        ${rombelOptions}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Kepala Sekolah dan Guru Accordion -->
                    <div class="border border-gray-300 rounded-md">
                        <div id="accordion-header-guru" aria-expanded="false" aria-controls="accordion-body-guru" class="identitas-section-header flex justify-between items-center p-4">
                            <h2 class="flex items-center text-gray-900 font-semibold text-base">
                                <i class="fas fa-users text-indigo-700 text-lg mr-3"></i>Kepala Sekolah dan Guru
                            </h2>
                            <i class="identitas-toggle-icon fas fa-chevron-down text-gray-500"></i>
                        </div>
                        <div id="accordion-body-guru" role="region" aria-labelledby="accordion-header-guru" class="identitas-section-body px-4">
                             <div class="grid grid-cols-1 sm:grid-cols-2 gap-5 max-w-4xl">
                                <div>
                                    <label class="text-xs font-semibold text-gray-700 block mb-1" for="namaKepalaSekolah">Nama Kepala Sekolah</label>
                                    <input id="namaKepalaSekolah" name="kepalaSekolah" type="text" value="${identitasData.kepalaSekolah || ''}" placeholder="Nama lengkap & gelar" class="w-full border border-gray-300 rounded-md px-3 py-2 text-xs placeholder:text-gray-400 focus:outline-none focus:ring-1 focus:ring-indigo-600"/>
                                </div>
                                <div>
                                    <label class="text-xs font-semibold text-gray-700 block mb-1" for="namaGuruKelas">Nama Guru</label>
                                    <input id="namaGuruKelas" name="guruKelas" type="text" value="${identitasData.guruKelas || ''}" placeholder="Nama lengkap & gelar" class="w-full border border-gray-300 rounded-md px-3 py-2 text-xs placeholder:text-gray-400 focus:outline-none focus:ring-1 focus:ring-indigo-600"/>
                                </div>
                                <div>
                                    <label class="text-xs font-semibold text-gray-700 block mb-1" for="nipKepalaSekolah">NIP Kepala Sekolah</label>
                                    <input id="nipKepalaSekolah" name="nipKepsek" type="text" value="${identitasData.nipKepsek || ''}" placeholder="NIP tanpa spasi" class="w-full border border-gray-300 rounded-md px-3 py-2 text-xs placeholder:text-gray-400 focus:outline-none focus:ring-1 focus:ring-indigo-600"/>
                                </div>
                                <div>
                                    <label class="text-xs font-semibold text-gray-700 block mb-1" for="nipGuruKelas">NIP Guru</label>
                                    <input id="nipGuruKelas" name="nipGuru" type="text" value="${identitasData.nipGuru || ''}" placeholder="NIP tanpa spasi" class="w-full border border-gray-300 rounded-md px-3 py-2 text-xs placeholder:text-gray-400 focus:outline-none focus:ring-1 focus:ring-indigo-600"/>
                                </div>
                                <div>
                                    <label class="text-xs font-semibold text-gray-700 block mb-1" for="waKepalaSekolah">WhatsApp Kepala Sekolah</label>
                                    <input id="waKepalaSekolah" name="waKepsek" type="tel" value="${identitasData.waKepsek || ''}" placeholder="08123456789" class="w-full border border-gray-300 rounded-md px-3 py-2 text-xs placeholder:text-gray-400 focus:outline-none focus:ring-1 focus:ring-indigo-600"/>
                                    <p class="text-xs text-gray-500 mt-1">Hanya angka, 10-13 digit, diawali 08.</p>
                                </div>
                                <div>
                                    <label class="text-xs font-semibold text-gray-700 block mb-1" for="waGuru">WhatsApp Guru</label>
                                    <input id="waGuru" name="waGuru" type="tel" value="${identitasData.waGuru || ''}" placeholder="08123456789" class="w-full border border-gray-300 rounded-md px-3 py-2 text-xs placeholder:text-gray-400 focus:outline-none focus:ring-1 focus:ring-indigo-600"/>
                                    <p class="text-xs text-gray-500 mt-1">Hanya angka, 10-13 digit, diawali 08.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>`;

            const form = page.querySelector('#identitas-form');
            const simpanBtn = page.querySelector('#simpan-identitas-btn');
            
            form.addEventListener('input', () => {
                simpanIdentitas();
                saveIdentitasStateToHistory(identitasData);
            });
            form.addEventListener('change', () => {
                simpanIdentitas();
                saveIdentitasStateToHistory(identitasData);
            });

            const updateSimpanButtonState = () => {
                const validation = validateIdentitasForm();
                if (validation.isValid) {
                    simpanBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    simpanBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            };

            form.addEventListener('input', updateSimpanButtonState);
            form.addEventListener('change', updateSimpanButtonState);
            
            updateSimpanButtonState();
            updateUndoRedoButtonsIdentitas();

            form.addEventListener('click', (e) => {
                const header = e.target.closest('.identitas-section-header');
                if (header) {
                    const body = header.nextElementSibling;
                    const icon = header.querySelector('.identitas-toggle-icon');
                    const isExpanded = body.classList.toggle('open');
                    header.setAttribute('aria-expanded', isExpanded);
                    icon.classList.toggle('rotate-180', isExpanded);
                }
            });
            const firstHeader = form.querySelector('.identitas-section-header');
            if(firstHeader){
                firstHeader.nextElementSibling.classList.add('open');
                firstHeader.querySelector('.identitas-toggle-icon').classList.add('rotate-180');
            }

            page.querySelector('#simpan-identitas-btn').addEventListener('click', () => {
                simpanIdentitas();
                saveIdentitasStateToHistory(identitasData);
                const validation = validateIdentitasForm();
                if (validation.isValid) {
                    saveState();
                    isIdentitasComplete = true;
                    updateTabLockState();
                    sendToGoogleSheet(identitasData); // Kirim data ke Google Sheet
                    showNotification('Data identitas berhasil disimpan. Anda kini dapat melanjutkan ke tab berikutnya.');
                } else {
                    let message = '';
                    if (validation.emptyFields.length > 0) {
                        message += `Harap lengkapi bagian berikut:\n\n• ${validation.emptyFields.join('\n• ')}`;
                    }
                    if (validation.invalidFields.length > 0) {
                        if (message) message += '\n\n';
                        message += `Format isian tidak valid:\n\n• ${validation.invalidFields.join('\n• ')}`;
                    }
                    showNotification(message);
                }
            });
            
            page.querySelector('#undo-identitas-btn').addEventListener('click', () => {
                if (identitasHistoryIndex > 0) {
                    identitasHistoryIndex--;
                    identitasData = JSON.parse(JSON.stringify(identitasHistory[identitasHistoryIndex]));
                    renderIdentitasPage();
                    saveState();
                }
            });

            page.querySelector('#redo-identitas-btn').addEventListener('click', () => {
                if (identitasHistoryIndex < identitasHistory.length - 1) {
                    identitasHistoryIndex++;
                    identitasData = JSON.parse(JSON.stringify(identitasHistory[identitasHistoryIndex]));
                    renderIdentitasPage();
                    saveState();
                }
            });

            page.querySelector('#reset-identitas-btn').addEventListener('click', () => {
                showConfirmation('Apakah Anda yakin ingin mereset semua data pada form ini?', () => {
                    const emptyData = { geminiApiKey: identitasData.geminiApiKey || '' }; // PERBAIKAN: Hanya pertahankan API Key
                    identitasData = emptyData; // PERBAIKAN: Set identitasData menjadi kosong
                    saveIdentitasStateToHistory(emptyData); // Simpan state kosong ke history
                    isIdentitasComplete = false;
                    renderIdentitasPage(); // Render ulang halaman dengan data kosong
                    updateTabLockState();
                    showNotification('Formulir identitas telah direset.');
                });
            });

            // NEW LISTENERS
            page.querySelector('#template-identitas-btn').addEventListener('click', handleIdentitasTemplate);
            page.querySelector('#ekspor-identitas-btn').addEventListener('click', handleIdentitasExport);
            
            const importIdentitasBtn = page.querySelector('#impor-identitas-btn');
            const importIdentitasFileInput = page.querySelector('#import-identitas-file-input');
            importIdentitasBtn.addEventListener('click', () => importIdentitasFileInput.click());
            importIdentitasFileInput.addEventListener('change', handleIdentitasImport);
        };

        const setupEventListeners = () => {
             DOMElements.tabNav.addEventListener('keydown', (e) => {
                const tabs = Array.from(DOMElements.tabNav.querySelectorAll('[role="tab"]:not(:disabled)'));
                let currentIndex = tabs.findIndex(tab => tab === document.activeElement);

                if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
                    e.preventDefault();
                    tabs[currentIndex].setAttribute('tabindex', '-1');
                    if (e.key === 'ArrowRight') {
                        currentIndex = currentIndex + 1 >= tabs.length ? 0 : currentIndex + 1;
                    } else if (e.key === 'ArrowLeft') {
                        currentIndex = currentIndex - 1 < 0 ? tabs.length - 1 : currentIndex - 1;
                    }
                    tabs[currentIndex].setAttribute('tabindex', '0');
                    tabs[currentIndex].focus();
                    showTab(tabs[currentIndex].dataset.tab);
                }
            });
            DOMElements.tabNav.addEventListener('click', e => {
                const button = e.target.closest('button');
                if (button && button.dataset.tab) {
                    if (button.disabled) return;
                    showTab(button.dataset.tab);
                }
            });
            DOMElements.btnTambahKegiatan.addEventListener('click', () => {
                tambahKegiatan(true);
                captureAndSavePerancanganState();
            });
            DOMElements.kegiatanContainer.addEventListener('click', (e) => {
                 handlePerancanganClick(e);
                 const button = e.target.closest('button');
                 if (button) {
                     captureAndSavePerancanganState();
                 }
            });
            DOMElements.kegiatanContainer.addEventListener('input', e => { if (e.target.matches('.nama-kegiatan, .subdimensi-checkbox')) captureAndSavePerancanganState(); });
            DOMElements.kegiatanContainer.addEventListener('change', e => { if (e.target.matches('.dimensi-select')) captureAndSavePerancanganState(); });
            const asesmenContent = DOMElements.tabContents.asesmen;
            if (asesmenContent) {
                 asesmenContent.addEventListener('change', e => { if (e.target.matches('.capaian')) { simpanAsesmen(currentAsesmenViewId); saveState(); } });
            }
            DOMElements.btnSaveTemplate.addEventListener('click', handleSaveTemplate);
            DOMElements.btnExportData.addEventListener('click', handleExportData);
            DOMElements.btnImportData.addEventListener('click', () => DOMElements.importFileInput.click());
            DOMElements.importFileInput.addEventListener('change', processImportedFile);
            
            DOMElements.panduanBtn.addEventListener('click', () => openModal(DOMElements.panduanModal));
            DOMElements.closePanduanBtn.addEventListener('click', closeModal);
            DOMElements.panduanModal.addEventListener('click', (e) => { if (e.target === DOMElements.panduanModal) closeModal(); });

            DOMElements.profilBtn.addEventListener('click', () => openModal(DOMElements.profilModal));
            DOMElements.closeProfilBtn.addEventListener('click', closeModal);
            DOMElements.profilModal.addEventListener('click', (e) => { if (e.target === DOMElements.profilModal) closeModal(); });

            DOMElements.btnClearState.addEventListener('click', clearState);
            DOMElements.notifikasiOkBtn.addEventListener('click', closeModal);

            DOMElements.closeEksporLaporanBtn.addEventListener('click', closeModal);
            DOMElements.eksporLaporanModal.addEventListener('click', (e) => { if (e.target === DOMElements.eksporLaporanModal) closeModal(); });
            DOMElements.exportToExcelBtn.addEventListener('click', () => { closeModal(); handleExportExcel(); });
            DOMElements.exportToPdfBtn.addEventListener('click', () => { closeModal(); handleExportPdf(); });
            
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                }
            });
            
            const perancanganContent = DOMElements.tabContents.perancangan;
            perancanganContent.addEventListener('click', e => {
                const undoBtn = e.target.closest('#undo-perancangan-btn');
                const redoBtn = e.target.closest('#redo-perancangan-btn');

                if (undoBtn) {
                    if (perancanganHistoryIndex > 0) {
                        perancanganHistoryIndex--;
                        kegiatanData = JSON.parse(JSON.stringify(perancanganHistory[perancanganHistoryIndex]));
                        renderFromState();
                        updateUndoRedoButtonsPerancangan();
                        saveState();
                    }
                }

                if (redoBtn) {
                     if (perancanganHistoryIndex < perancanganHistory.length - 1) {
                        perancanganHistoryIndex++;
                        kegiatanData = JSON.parse(JSON.stringify(perancanganHistory[perancanganHistoryIndex]));
                        renderFromState();
                        updateUndoRedoButtonsPerancangan();
                        saveState();
                    }
                }
            });

            DOMElements.btnBackup.addEventListener('click', () => {
                saveState();
                const state = localStorage.getItem('raporKokurikulerState');
                const blob = new Blob([state], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Edi Brata_Kokurikuler_Backup_${getFormattedTimestamp(true)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification('Seluruh data berhasil di-backup.');
            });

            DOMElements.btnRestore.addEventListener('click', () => {
                DOMElements.restoreFileInput.click();
            });

            DOMElements.restoreFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    showConfirmation('Ini akan menimpa semua data saat ini. Apakah Anda yakin ingin melanjutkan?', () => {
                        try {
                            const state = JSON.parse(e.target.result);
                            localStorage.setItem('raporKokurikulerState', JSON.stringify(state));
                            loadState();
                            renderFromState();
                            renderIdentitasPage();
                            updateTabLockState();
                            showTab('identitas');
                            showNotification('Data berhasil di-restore.');
                        } catch (err) {
                            showNotification('Gagal memuat file backup. Pastikan Anda memilih file .json yang benar yang diunduh dari aplikasi ini.');
                            console.error("Restore error:", err);
                        }
                    });
                };
                reader.readAsText(file);
                event.target.value = null;
            });
        };

        const init = () => {
            if (loadState()) {
                renderFromState();
            } else {
                renderFromState();
            }
            updateTabLockState();
            showTab('identitas');
            setupEventListeners();
        };
        
        init(); // PANGGILAN init() DIPERTAHANKAN DI SINI, DI DALAM DOMContentLoaded
    });
    </script>
</body>
</html>
